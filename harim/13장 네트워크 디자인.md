# 13장 네트워크 디자인
- 호스트와 호스트 간 통신이 가능하도록 해주는 기반이 되는 인프라를 네트워크라고 함
- 네트워크 디자인과 구성에 따라 호스트 간 통신 경로가 달라지고 서비스 품질에도 영향을 미침
- 네트워크를 구성하는 작업은 매우 복잡하고 다양하며 네트워크 구조와 설계는 전체 서비스와 인프라에 매우 큰 영향을 미침

## 13.1 2계층/3계층 네트워크
### 2계층 네트워크
- 호스트 간 통신이 직접 2계층 통신만으로 이루어지는 네트워크 디자인임
- 2계층 통신을 하려면 통신할 호스트가 동일한 네트워크여야 함
- 동일한 네트워크 간 통신이므로 게이트웨이를 거치지 않고 직접 호스트 간 통신이 가능한 구조임
- 2계층 네트워크의 구성 방법
  - 하나의 브로드캐스트 도메인이 되고 루프 구조가 생기면 문제가 발생하기 때문에 스패닝 트리 프로토콜(STP)을 사용해 문제를 해결함
  - 스패닝 트리 프로토콜(STP) 사용으로 블록포인트가 생기면서 전체 인프라의 대역폭을 사용하지 못하는 문제가 있음
  - 이 문제를 해결하려면 논블로킹 구조를 만들어야 함
  - MC-LAG와 같은 기술을 이용해 루프를 제거하고 논블로킹 구조를 구현할 수 있음 

### 3계층 네트워크
- 호스트 간 통신이 IP 라우팅과 같은 3계층 통신으로 이루어지는 네트워크 디자인임
- 라우팅으로 구성된 네트워크 구조이므로 루프 문제가 발생하지 않음
- 전체 네트워크 인프라의 대역폭을 ECMP(Equal-Cost Multi-Path) 라우팅 기술을 이용해 모두 사용할 수 있음
- 네트워크 장비 연결마다 다른 네트워크를 가지고, 네트워크에 연결되어 있는 단말도 다른 네트워크 장비에 연결되어있다면 다른 네트워크를 갖게 됨
  - 브로드캐스트로 상대방 호스트를 직접 찾을 수 없어, 이런 형태의 통신이 필요하다면 3계층 기반 디자인을 사용할 수 없음
- 하지만 VxLAN과 같은 오버레이 네트워크 기술을 사용해 하단 호스트 간에 동일한 네트워크를 사용하면서도 네트워크 장비 간에 3계층 통신을 하도록 구성할 수 있음
  - 이런 구성은 2계층 네트워크를 확장하면서도 3계층의 장점인 루프 없이 전체 네트워크 대역폭을 사용하는 것을 가능하게 해줌
  - 이런 오버레이 기술은 VxLAN이나 GRE와 같은 터널링 프로토콜을 기반으로 함

## 13.2 3-Tier 아키텍처
- 코어-어그리게이션-액세스 3계층으로 이루어진 네트워크 아키텍처는 전통적인 네트워크 디자인 기법임
- 3-Tier 아키텍처 구성
  - 호스트가 직접 연결된 액세스 계층에 스위치가 있음
  - 액세스 스위치를 중간에서 집선하는 어그리게이션 스위치가 그 상단에 있음
  - 코어 계층 스위치는 어그리게이션 스위치를 다시 모아 서로 통신할 수 있게 연결해줌
 
 ![image](https://user-images.githubusercontent.com/88179702/183401743-d443e6c6-db03-4ea4-b358-64e42a2b5f3b.png)

## 13.3 2-Tier 아키텍처
### 스파인-리프 구조
- 2-Tier 아키텍처 스파인-리프 구조 구성
  - 하단 호스트가 연결되는 리프스위치는 상단 스파인 스위치가 연결됨
  - 리프 스위치와 스파인 스위치 간에는 전통적인 2계층 스패닝 트리가 동작하지 않고 모든 링크를 사용해 트래픽을 전송함
- 사용 이유
  - 데이터 센터 내 계층이 복잡할 수록 서버간 통신(East-West 트래픽)이 많은 현대 네트워크에서는 네트워크 부하가 커지고 성능 지연이 발생할 수 있기 때문에, 이 문제를 보완하기 위해 사용
- 스파인-리프 네트워크 디자인에서는 동일 리프 스위치에 호스트가 연결된 경우를 제외하면 모든 호스트 간 통신 홉이 동일함
- 출발지 리프 스위치를 지나 스파인 스위치를 거쳐 목적지 리프 스위치로 트래픽이 흘러 네트워크 흐름에 대한 홉 수가 짧아지고 트래픽 흐름이 일정해진다는 장점이 있음
- 스파인-리프 스위치 사이는 2계층 네트워크나 3계층 네트워크로 구성할 수 있음

### L2 패브릭
- 스파인-리프 구조에서 스파인-리프 사이를 2계층 네트워크로 구성하는 방법
- L2패브릭을 구성하기 위해 TRILL(TRansparent Interconnection of Lots of Links)이나 SPB(Shortest Path Bridging)와 같은 프로토콜을 사용할 수 있음
- 일반적인 2계층 구조에서는 루프에 대한 제약때문에 모든 링크를 활성화할 수 없지만, TRILL이나 SPB와 같은 프로토콜은 이런 문제를 해결하도록 구현돼있음
- 시스코의 Fabrc Path나 익스트림의 VCS Fabric같은 기술도 이 프로토콜 기반으로 L2 패브릭을 만들 수 있게 한 벤더의 기술 명칭임

### L3 패브릭
- 스파인-리프 구조에서 스파인과 리프 사이를 3계층 네트워크로 구성하는 방법
- 스파인과 리프가 연결된 링크는 각각 라우팅이 활성화되어있고, 일반적인 라우팅 프로토콜을 이용해 경로 정보를 교환함
- 라우팅으로 구성되어있어 별도의 특별한 기술 없이도 루프를 제거하고 ECMP를 통해 모든 링크를 사용할 수 있음
- 스파인-리프 구조를 L3 패브릭으로 구성할 경우, 하단 호스트의 네트워크가 리프 간에 서로 다른 네트워크를 갖게 됨
- 동일한 네트워크 구성이 필요할 때는 VxLAN과 같은 오버레이 네트워크 기술을 이용해 상단에 L3 패브릭으로 구성된 스파인-리프 구조에서도 리프 하단의 L2 네트워크를 확장해 동일한 네트워크를 가질 수 있음
  - 이런 환경은 가상화 서버의 라이브 마이그레이션과 같은 서비스를 위해 사용됨
  - 이런 오버레이 기술을 사용하면 IP 이동이 보장되는 네트워크를 구성할 수 있음

## 13.4 데이터 센터 Zone/PoD 내부망/DMZ망/인터넷망
- 데이터 센터를 설계할 때는 데이터 센터의 다양한 구성 요소와 역할을 고려해야 함
- 보안과 관리상의 이유로 용도별로 데이터 센터망을 분리해 설계함
- 분리된 망은 용도별로 나눠져있어 망 간 보안을 고려해 방화벽과 같은 보안 장비와 연동하도록 구성해야 함

### 인터넷망
- 인터넷망이란
  - 외부 인터넷에서 사용자가 데이터 센터에 접근할 수 있도록 구성된 영역
  - KT, LGU+, SKB와 같은 ISP(Internet Service Provider)에서 인터넷 회선을 받아 연동되어 있음
- 소규모 데이터 센터는 ISP에서 IP를 할당받아 인터넷에 쉽게 연결할 수 있지만, 규모가 큰 데이터 센터는 ISP와 연동할 때 BGP 프로토콜을 이용하고 별도의 AS(Autonomous System) 번호를 가짐
- 단일 회선을 가지고있더라도 자신이 소유한 IP를 사용하려면 AS 번호를 할당받고 BGP 프로토콜을 이용해 ISP에 연결해야 함
- 규모가 크다면 서비스 안정성을 위해 ISP 연결을 이중화/삼중화 함

### 공인망(DMZ)
- 공인망이란
  - 데이터 센터에서 외부 사용자에게 직접 노출되는 웹 서비스 등의 서버들이 모인 망
  - 데이터 센터 외부 접근을 위해 공인 IP가 사용되어 공인망이라고 부르거나, 서비스를 외부로 제공하므로 서비스망이라고도 부름
  - 언트러스트 네트워크인 데이터센터 외부의 인터넷 구간과 트러스트 네트워크인 데이터 센터 내부망의 연결 지점 역할을 하므로 군사 분계선을 뜻하는 DMZ라고도 부름

### 내부망(사내망/사설망)
- 내부망이란
  - 데이터센터 내부나 사내에서만 접근할 수 있는 네트워크
  - 내부망은 일반적으로 사설 대역의 IP로 구성하므로 인터넷을 통한 외부망에서는 직접 접근할 수 없음
- 내부망 중 데이터 센터 관리나 내부 직원용 서버팜인 경우, 보안상 외부 망과의 연결을 단절하거나 최소화 해야 함
- 외부망과 통신할 때는 사설 IP로 통신할 수 없으므로 외부망으로 나가려면 중간에 공인 IP로 변환해주는 NAT가 필요함
- 원격지에 있는 내부망 간 연결은 VPN이나 전용선으로 연결할 수 있음

### 데이터베이스망
- 개인정보를 취급하는 경우가 많아 보안을 강화하기 위해 나부망에 데이터베이스망을 별도로 두기도 함
- 공인망으로부터 내부망을 보호하기 위해 방화벽을 두듯, 데이터베이스망도 내부망에서 접근할 때 추가로 방화벽을 두고 별도 망을 구성할 수 있음
- 서버간 통신이 아니면 보안을 더 강화하기 위한 접근 통제 시스템을 운영하고, 데이터베이스에 접속할 때는 접근 통제 시스템을 통해야만 가능하도록 구성함

### 대외망
- 다른 대외사와의 연동을 위해 별도 망으로 분리하기도 함
  - 회사 대 회사로 서비스 연동이 필요한 경우, 인터넷망을 통해 연동할 수도 있지만, 별도 전용선이나 VPN을 이용해 서비스를 연동할 수도 있음
  - 금융서비스와 같이 보안이 더 필요한 경우, 전용 회선과 VPN을 동시에 사용하기도 함
  - 대외사와 연동된 지점에서 사내로 접근할 때 서비스에 필요한 최소한의 접근만 허용하기 위해서 사용

### 관리망/OoB(Out of Band)
- 데이터센터 내 서버나 네트워크 장비는 서비스를 위한 인터페이스도 있지만, 장비 자체를 관리하기 위한 관리용 인터페이스를 별도로 제공하기도 함
- 네트워크 관리망과 서버 관리망은 목적이나 운영방법에서 다름
- 네트워크 관리망
  - 보통 장비 운영을 위한 CLI나 웹 접속을 위해 사용됨
  - 일반 서비스망으로도 장비에 접근할 수 있어 관리망과 별도 서비스망 접근에는 큰 차이가 없음
  - 서비스망과의 분리가 필요한 이유는 서비스망에 문제가 발생하더라도 서비스망과 별도로 분리된 관리망을 통해 장비에 접근해야 하기 때문
- 서버 관리망
  - 서버관리망은 일반적인 서비스망과 다름
  - 하드웨어 자체를 관리하기 위한 별도의 환경임
  - 서버 관리망을 통해 콘솔 접근이 가능하지만, 기본적으로 하드웨어 자체를 관리하기 위한 환경임

## 13.5 케이블링과 네트워크
- 데이터 센터 내에서 스위치와 서버 간 케이블링 구성방식에 따라 ToR과 EoR로 구분할 수 있음

### ToR
- Top of Rack
- 랙 상단에 개별적으로 설치되는 스위치 구성
- 일반적으로 각 랙 최상단에 ToR 스위치를 구성하고, 해당 랙에 있는 서버들을 연결함
- 랙 내에서의 서버 집적도, 물리적 네트어크 분리, 이중화 요건에 따라 랙 내 스위치는 두대 이상이 될 수도 있고, 랙 두개를 묶어 하나의 스위치로 관리할 수 도 있음
- 세부 구성과 상관 없이 ToR 스위치는 랙 안에 설치된 서버들을 직접 연결하고 상단 네트워크 장비는 별도의 네트워크 랙에 구성되어 서로 연결됨
- 결국 각 랙에 구성된 서버들은 해당 랙에 있는 ToR 스위치에 연결되고, ToR 스위치는 상단 네트워크 장비에 모두 연결되는 구성임
- 서버가 스위치와 동일한 랙(또는 인접한 랙)에 있으므로 케이블링의 길이나 복잡성이 줄어듦
- 스위치가 많이 필요하므로 네트워크 장비에 대한 관리사항이 늘어남

### EoR
- End of Row
- 랙이 있는 행 끝에 네트워크 장비를 두고 각 랙에 있는 서버는 네트워크 장비가 있는 랙까지 케이블로 연결됨
- 즉, 서버가 있는 랙과 네트워크 장비가 있는 랙을 분리한 구성임
- 관리하는 장비 수와 통과하는 스위치 수가 줄어 대기시간이나 지연에 유리
- 하지만 복잡도가 높고 케이블이 길어짐

### MoR
- Middle of Row
- 서버에 연결될 네트워크 장비 랙을 별도로 구성하는 점은 EoR과 같지만, 네트워크 장비의 랙을 행 끝이 아닌 중간에 두는 경우
- 케이블 길이가 EoR에 비해 감소하는 장점이 있음
  
  
  
