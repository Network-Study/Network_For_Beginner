# 7장 통신을 도와주는 네트워크 주요 기술
- DHCP (Dynamic Host Configuration Protocol)
  - 사용자가 IP 설정을 하지 않더라도 IP 주소를 자동으로 할당해주는 프로토콜
- DNS (Domain Name System)
  - 사용자가 복잡한 목적지 IP를 외우지 않고 쉬운 도메인 이름을 사용할 수 있도록 도메인 이름과 IP 주소를 매핑해주는 서비스
- GSLB(Global Service Load Balancing)
  - 사용자가 가장 가까운 지역의 데이터 센터에 접속해 신속한 서비스를 받게 해주는 서비스
- NAT (Network Address Translation)
  - 하나의 IP를 사용해 여러 단말 장비를 포함하는 네트워크를 구축하도록 도와주는 기술

## NAT/PAT
- NAT
  - 네트워크 주소 변환기술
  - IP 주소를 다른 IP 주소로 변환하는 것을 전부 NAT라고 하지만, 주로 사설 IP 주소에서 공인 IP 주소로 전환할 때 많이 사용함
  - ex) 가정에서 사용하는 노트북과 PC는 공유기로, 스마트폰은 통신사 장비를 통해서 NAT를 수행해 외부와 통신함
  - 하나의 네트워크 주소에 다른 하나의 네트워크 주소로 변환하는 1:1 변환하는 것이 기본이지만, IP 주소 고갈 문제로 여러 개의 IP를 하나의 IP로 변환하기도 함
  - NAPT(=PAT)
    - 여러 개의 IP를 하나의 IP로 변환하는 기술
 
### NAT/PAT의 용도와 필요성
1. IPv4 주소 고갈 문제의 솔루션으로 NAT 사용
  - IPv4 주소 보노 전략
    - 단기 전략: 서브네팅
    - 중기 전략: NAT, 사설 IP 체계
      - NAT 사용한 중기 전략이 IPv4 주소 보존에 큰 기여
      - 외부에 공개해야 하는 서비스에 대해서는 공인 IP를 사용하고, 외부에 공개할 필요가 없는 일반 사용자의 PC나 기타 종단 장비에 대해서는 사설 IP를 사용해 꼭 필요한 곳에만 효율적으로 사용
    - 장기 전략: IPv6 전환
2. 보안을 강화하는데 NAT 기술 사용
  - 외부와 통신할 때 내부 IP를 다른 IP로 변환해 통신하면 외부에서 사내 IP 주소 체계를 숨길 수 있음
  - 내부 네트워크에서 외부 네트워크로 나가는 통신은 허용하지만, 외부에서 내부로 들어오는 통신은 방어할 수 있음
3. IP 주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해줌
  - 공인 IP는 인터넷에서 유일한 주소로 IP 주소가 중복되면 안되지만, 사설 IP는 외부와 통신할 때 공인 IP로 변환되어 통신하므로 서로 다른 회사에서 중복 사용 가능
  - 사설 IP를 이용해 다른 회사와 직접 연결하거나 회사 간 합병으로 서로 통신해야 한다면 사설 IP 주소 충돌 발생 가능
  - IP 대역이 같은 네트워크와 통신할 가능성이 높은 대외계 네트워크(ex. 카드사, 은행 간 연결)를 연결하기 위해 출발지와 도착지를 한꺼번에 변환하는 Double NAT 기술 사용
4. 불필요한 설정 변경
  - KISA를 통해 인터넷 독립기관으로 직접 등록하고 소유한 IP 주소를 직접 운영하는 경우가 아니라면 통신사업자나 IDC 쪽에서 IP를 할당받아 사용함
    - 임시로 빌려 사용하는 것이기 때문에 회선 사업자를 바꾸거나 IDC를 이전하면 신규 사업자가 빌려주는 IP로 변경해야 함
  - NAT/PAT 기술을 적용하면, DNS 서비스나 NAT 수행 장비 설정은 변경해야 하지만 내부 서버나 PC 설정 변경을 최소화 할 수 있음
- NAT의 단점
  - 네트워크 운영자 입장에서 IP 가 변환되면 장애가 발생했을 때 문제 해결이 어려움
  - 애플리케이션 개발자 입장에서 개발 시 더 많은 고려사항이 생김
  - NAT로 주소가 변환되며 단말 간 직접적인 연결성이 무너졌고, 개발자들이 애플리케이션을 제작할 때 NAT 환경을 항상 고려해야 함

### NAT 동작 방식

![image](https://user-images.githubusercontent.com/88179702/173310943-b9e30302-c766-4329-ae67-e40613ca94b5.png)

1. 사용자가 웹서버에 접근하기 위해 출발지 IP를 10.10.10.10으로, 목적지 IP와 서비스 포트는 20.20.20.20과 80으로 패킷을 전송함(출발지 서비스 포트는 임의로 할당됨)
2. NAT 역할을 수행하는 장비에서 사용자의 패킷을 수신하고 NAT 정책에 따라 외부 네트워크와 통신이 가능한 공인 IP인 11.11.11.11로 IP 주소를 변경함
   NAT 장비에서 변경 전후의 IP 주소는 NAT 테이블에 저장됨
3. NAT 장비에서 출발지 주소를 11.11.11.11로 변경해 목적지 웹 서버로 전송함
4. 패킷을 수신한 웹서버느 사용자에게 응답을 보냄. 수신한 내용과 반대로 출발지는 웹서버(20.20.20.20), 목적지는 NAT 장비에 의해 변환된 공인 IP 11.11.11.11로 사용자에게 전송
5. 웹서버로부터 응답 패킷을 수신한 NAT 장비는 자신의 NAT 테이블에서 목적지 IP에 대한 원래 패킷을 발생시킨 출발지 IP 주소가 10.10.10.10 인 것을 확인함
6. NAT 변환 테이블에서 확인된 원래 패킷 출발지 IP(10.10.10.10)로 변경해 사용자에게 전송하면 사용자는 최종적으로 패킷을 수신함

### PAT 동작 방식

![image](https://user-images.githubusercontent.com/88179702/173311932-fdb9c934-8618-49a8-839d-7016d24d0087.png)

1. 사용자가 웹서버로 접근하기 위해 출발지 10.10.10.10, 목적지 IP와 웹서비스 포트 20.20.20.20과 80으로 패킷을 전송 (출발지 서비스 포트는 임의의 서비스 포트 할당)
2. NAT 장비는 사용자가 보낸 패킷을 받아 외부 네트워크와 통신이 가능한 공인 IP인 11.11.11.11로 변경.
   다수의 사용자가 동일한 공인 IP로 변환되어야 하므로 주소 변경 시 출발지 IP 뿐만 아니라 출발지의 서비스 포트도 변경됨. (NAT 테이블에 기록)
3. NAT 장비에서 변경된 출발지 IP 주소인 11.11.11.11과 서비스 포트 3000으로 패킷을 재작성해 웹 서버로 다시 전송함
4. 사용자가 보낸 패킷을 수신한 웹 서버는 사용자에게 패킷을 응답하는데 출발지 IP는 웹서버의 IP 주소인 20.20.20.20이고 목적지 IP는 NAT에 의해 변환된 공인 IP 11.11.11.11, 서비스 포트로 전송됨
5. 웹서버로부터 응답 패킷을 수신한 NAT 장비는 NAT 테이블을 확인해 패킷의 목적지 IP 주소인 11.11.11.11이 원래 10.10.10.10이고 서비스 포트 3000이 원래 2000인 것을 확인함
6. NAT 장비는 NAT 테이블에서 확인한 목적지 IP 주소와 서비스 포트로 패킷을 재작성한 후 사용자에게 전달함. 사용자는 NAT 장비에서 역변환된 패킷을 받아 웹페이지를 표시함

- PAT 동작 방식은 NAT와 거의 동일하게 이루어지지만, IP 주소뿐만 아니라 서비스 포트까지 함께 변경해 NAT 테이블을 관리하므로 하나의 IP만으로도 다양한 포트번호로 사용자를 구분할 수 있음
- 서비스 포트가 동시에 모두 사용중이거나 재사용할 수 없을 때에는 정상 동작하지 않기 때문에 동시 사용자가 매우 많을 때에는 공인 IP 주소를 IP 하나가 아닌 풀(Pool)로 구성해야 함
- PAT는 다수의 IP가 있는 출발지에서 목적지로 갈 때 NAT 테이블이 생성되고 응답에 대해 NAT 테이블 참조
- PAT IP가 목적지일 때는 해당 IP가 어느 IP에 바인딩되는지 확인할 수 있는 NAT 테이블이 없으므로 사용 불가
- 즉, 내부에서 외부로 출발하는 경우에만 가능함

### SNAT와 DNAT
- SNAT(Source NAT): 출발지 주소를 변경하는 NAT
  - 사설에서 공인으로 통신할 때 많이 사용함
    - 공인 IP 주소의 목적지에서 출발지로 다시 응답을 받으려면 출발지 IP 주소 경로가 필요한데 공인 대역에서는 사설 대역의 경로를 알 수 없으므로 사용함
    - 공유기처럼 PAT를 사용하는 경우
  - 보안상 사내 IP를 다른 IP로 변경하기 위해 사용함
    - 회사에서 다른 대외사와 통신시 내부의 실제 IP 주소를 숨길 수 있음
  - 로드밸런서의 구성에 따라 사용하기도 함
    - 출발지와 목적지 서버가 동일한 대역일 때는 로드밸런서 구성에 따라 트래픽이 로드 밸런서를 거치지 않고 응답할 수 있어 SNAT를 통해 응답 트래픽이 로드 밸런서를 거치게 할 수 있음
- DNAT(Destination NAT): 도착지 주소를 변경하는 NAT
  - 로드 밸런서에서 많이 사용함
    - 사용자는 서비스 요청을 위해 로드 밸런서에 설정된 서비스 VIP(Virtual IP)로 서비스를 요청하고, 로드밸런서에서는 서비스 VIP를 로드 밸런싱 될 서버의 실제 IP로 DNAT해 내보냄
  - 대외망과의 네트워크 구성에 DNAT를 사용함
    - IP 중복 문제나 IP 주소가 제각각인 문제 때문에 대외망에 NAT 장비를 이용해 대외사의 IP를 특정 IP 대역으로 NAT함

![image](https://user-images.githubusercontent.com/88179702/173316151-f15c6893-aab7-4256-9333-bf584ffe89ee.png)

- SNAT와 DNAT의 기준은 NAT가 수행되기 이전의 트래픽이 출발하는 시작 지점임

### 동적 NAT와 정적 NAT
- 동적 NAT
  - 출발지와 목적지가 사전에 정해지지 않고 NAT를 수행할 때 IP를 동적으로 변경하는 NAT
  - 최소한 출발지나 목적지 중 한곳이 다수의 IP로 구성된 IP 풀이나 레인지로 설정돼있음
  - NAT를 수행하는 시점에 IP 풀에서 어떤 IP로 매핑될 것인지를 판단하고 테이블을 만들어서 관리함
  - NAT 테이블은 설정된 시간동안 유지되고 일정 시간 통신이 없으면 사라짐 => 서비스 흐름 고려해야 함
- 정적 NAT
  - 출발지와 목적지의 IP를 미리 매핑해 고정해놓은 NAT 
  - 1:1 NAT라고도 함
  - 방향성 없이 서비스 흐름을 고려하지 않고 NAT 설정할 수 있음

## DNS
- 네트워크 프로토콜의 분류
  1. 데이터 프로토콜
     - 실제로 데이터를 실어나름
  2. 컨트롤 프로토콜
     - 데이터 프로토콜이 잘 동작하도록 도와줌
     - 통신에 직접 관여하진 않지만 처음 통신 관계를 맺거나 유지하는데 큰 역할
     - ARP, ICMP, **DNS**
 - DNS
  - 도메인 주소를 IP 주소로 변환하는 역할
  - IP 주소보다 도메인 주소를 이용하는 것이 일반 사용자에게 더 익숙하고 서버 IP 변경에 쉽게 대처 가능
  - 클라우드 기반 인프라 구성으로 인프라가 빈번히 변경되어 DNS 설계가 더욱 중요
  - MSA 기반의 서비스 설계가 많아지면서 다수의 API를 이용하다 보니 사용자의 호출 뿐만 아니라 서비스 간 API 호출이나 인터페이스가 많아져 DNS 역할이 더욱 중요

### DNS 소개
- 숫자로 구성된 IP 주소보다 의미있는 문자열로 구성된 도메인 주소가 인간이 인식하고 기억하기에 쉬움
- IP 주소 대신 도메인 주소를 이용하면 하나의 IP 주소를 이용해 여러 개의 웹서비스를 운영할 수 있고, 서비스 중인 IP 줏과 변경되더라도 도메인 주소를 유지해 접속 방법 변경 없이 서비스 유지 가능
- 지리적으로 여러 위치에서 서비스할 수 있음
- 동작 과정
  1. 사용자가 웹 브라우저에 naver.com을 입력
  2. DNS 서버에 naver.com의 주소가 무엇인지 질의하고 DNS 서버에서 naver.com의 IP 주소가 202.179.177.21임을 알려줌
  3. 사용자는 DNS로 응답받은 202.179.177.21의 IP 주소를 이용해 실제 naver.com에 접속함

### DNS 구조와 명명 규칙
- 도메인은 계층구조여서 원하는 주소를 횽ㄹ적으로 찾을 수 있음
- 역트리 구조를 사용함
- 최상위 루트, Top-Level 도메인, Second-Level 도메인, Third-Level 도메인
- 각 계층의 경계를 "."으로 표시하고 뒤에서 앞으로 해석함
- Third.second.top.
- 맨 뒤의 루트"."는 생략

![image](https://user-images.githubusercontent.com/88179702/173320071-84ca64ec-526c-4737-b43d-d0f81c1bf6c9.png)

- 도메인 계층은 최대 128계층 까지 구성할 수 있음
- 전체 도메인 네임의 길이는 최대 255바이트
- 알파벳, 숫자, "-"만 사용할 수 있고 대소문자 구분이 없음
- **루트 도메인**
  - 도메인을 구성하는 최상위 영역
  - DNS 서버는 사용자가 쿼리한 도메인에 대한 값을 직접 갖고 있거나 캐시에 저장된 정보를 이용해 응담하는데, 만약 DNS 서버에 해당 도메인의 정보가 없으면 루트 도메인을 관리하는 루트 DNS에 쿼리함
  - 루트 DNS는 전 세계에 13개가 있음
  - DNS 서버를 설치하면 루트 DNS의 IP 주소를 기록한 힌트 파일을 가지고 있어 루트 DNS 관련 정보를 별도로 설정할 필요가 없음
- **Top-Level Domain(TLD)**
  - 최상위 도메인으로 6가지 유형이 존재
  1. Generic(gTLD)
     - 특별한 제한 없이 일반적으로 사용되는 최상위 도메인
     - .com, .edu, .gov, .int, .mil, .net, .org
  2. country-code(ccTLD)
     - 국가 최상위 도메인으로 두글자의 국가 코드를 사용함
     - 우리나라는 'kr'
     - 일반 회사는 co.kr, 정부 기관은 go.kr
  3. sponsored(sTLD)  
     - 민족 공동체, 전문가 집단 등 특정 목적을 위한 스폰서를 두고 있는 최상위 도메인
     - .aero, .asia, .edu, .museum
  4. infrastructure
     - 운용상 중요한 인프라 식별자 공간을 지원하기 위해 전용으로 사용되는 최상위 도메인
     - .arpa
  5. generic-restricted(grTLD)
     - 특정 기준을 충족하는 사람이나 단체가 사용할 수 있는 최상위 도메인
     - .biz, .name, .pro
  6. test(tTLD)
     - 개발 프로세스에서 테스트 목적으로 사용하는 최상위 도메인
     - .test

### DNS 동작 방식
- 클라이언트 관점  
  - 도메인을 IP 주소로 변환하려면 DNS 서버에 도메인 쿼리하는 과정을 거쳐야 함
  - DNS 서버 없이 로컬에 도메인과 IP 주소를 직접 설정해 사용할 수 도 있음 => hosts 파일
  - DNS 캐시 정보에는 기존 DNS 조회를 통해 확인한 동적 DNS 캐시와 hosts 파일에 저장되어 있는 정적 DNS 캐시가 함께 저장돼있음
  - DNS 정보는 캐시부터 조회하므로 캐시에 존재할 경우 별도고 DNS 서버에 쿼리하지 않음
- DNS 시스템 관점
  - DNS는 분산된 데이터 베이스로 설계되어 자신이 가진 도메인 정보가 아니면 다른 DNS에 질의해 결과를 받을 수 있음
  - DNS 기능을 서버에 올리면 DNS 서버는 기본적으로 루트 DNS 관련 정보를 가지고 있음
  - 클라이언트의 쿼리가 자신에게 없는 정보라면 루트 DNS에 쿼리하고 루트 DNS에서는 쿼리한 도메인의 TLD 값을 확인해 해당 TLD 값을 관리하는 DNS를 응답함
  - 즉, 클라이언트에서 처음 질의를 받은 DNS가 중심이 되어 책임지고 루트 DNS부터 상위 DNS에 차근차근 쿼리를 보내 결과값을 알아낸 후 최종 결과값만 클라이언트에 응답함
- 전체 과정
  1. 사용자 호스트는 zigispace.net이라는 도메인 주소의 IP 주소가 로컬 캐시에 저장되어 있는지 확인함
  2. zigispace.net이 로컬 캐시에 저장돼있지 않으면 사용자 호스트에 설정된 DNS에 zigispace.net에 대해 쿼리함
  3. DNS 서버는 zigispace.net이 로컬 캐시와 자체에 설정되어 있는지 직접 확인하고, 없으면 해당 도메인을 찾기 위해 루트 NS에 .net 에 대한 TLD 정보를 가진 도메인 주소를 쿼리함
  4. 루트 DNS는 zigispace.net의 TLD인 .net을 관리하는 TLD 네임서버 정보를 DNS 서버에 응답함
  5. DNS는 TLD 네임 서버에 zigispace.net에 대한 정보를 다시 쿼리함
  6. TLD 네임 서버는 zigispace.net에 대한 정보를 가진 zigi 네임 서버에 대한 정보를 DNS 서버로 응담함
  7. DNS는 zigi 네임 서버에 zigispace.net에 대한 정보를 쿼리함
  8. zigi 네임서버는 zigispace.net에 대한 정보를 DNS 응답함
  9. DNS는 zigispace.net에 대한 정보를 로컬 캐시에 저장하고 사용자 호스트에 zigispace.net에 대한 정보를 응답함
  10. 사용자 호스트는 DNS로부터 받은 zigispace.net에 대한 IP 정보를 이용해 사이트에 접속함

![image](https://user-images.githubusercontent.com/88179702/173323474-58195fee-b6cf-4fb9-95c0-f0877af734b0.png)

### 마스터와 슬레이브
- DNS 서버는 마스터 서버와 슬레이브 서버로 나눌 수 있음
- 마스터 서버가 우선순위가 더 높은것은 아님. 두 서버 모두 도메인 쿼리에 응답함
- 마스터와 슬레이브는 도메인에 대한 zone 파일을 직접 관리하는지 여부로 구분함
- 마스터 서버
  - 존 파일을 직접 생성해 도메인 관련 정보를 관리
- 슬레이브 서버
  - 마스터에 만들어진 존 파일을 복제함 
- 영역 전송 : 슬레이브 서버에서 마스터에 만들어진 존 파일을 복제하는 것
- 마스터 서버는 자신이 가진 도메인 정보를 인가받지 않은 다른 DNS 서버가 복제하지 못하도록 슬레이브 서버를 지정해 복제를 제한 할 수 있음
- DNS 서버는 마스터 서버에 문제가 발생하고 일정 시간이 지나면 슬레이브 서버도 도메인에 대한 질의에 정상적으로 응답할 수 없음(만료 시간)

### DNS 주요 레코드
- A(IPv4) 레코드
  - 도메인 주소를 IP 주소 (IPv4)로 매핑
  - 하나의 A 레코드에는 한개의 도메인 주소와 한 개의 IP 주소가 1:1로 매핑됨
  - 동일한 도메인을 가진 A 레코드를 여러개 만들어서 서로 다른 IP 주소와 매핑할 수 있음
  - 서버 한 대에 여러 웹 서비스를 구동해야 한다면 여러 도메인에 동일한 IP를 매핑하고 HTTP 헤더의 HOST 필드에 도메인을 명시해 웹 서버를 구분해 서비스 할 수 있음 
- AAAA(IPv6) 레코드
  - 도메인 주소를 IP 주소(IPv6)로 매핑
- CNAME(Canonical Name, 별칭) 레코드
  - 도메인 주소에 대한 별칭
  - 레코드 값에 도메인 주소를 매핑함
  - 대표적인 예로 www 가 있음
- SOA(Start Of Authority, 권한 시작) 레코드
  - 본 영역 데이터에 대한 권한
  - 현재 네임서버가 이 도메인 영역에 대한 관리 주체임을 의미하므로 해당 도메인에 대해서는 다른 네임서버에 질의하지 않고 직접 응답함
- NS(Name Server) 레코드
  - 본 영역에 대한 네임 서버
  - 도메인에 대한 권한이 있는 네임 서버 정보를 설정하느 레코드임
  - 하위 도메인에 대한 권한을 다른 네임 서버로 위임하는 역할로도 많이 사용함
- MX(Mail eXchange, 메일교환기) 레코드
  - 메리 서버를 구성할 때 사용되는 레코드임
  - 우선순위 값을 이용해 다수의 MX 레코드를 선언할 수 있음
- PTR(Pointer) 레코드 
  - IP 주소를 도메인에 매핑(기본적인 A 레코드의 역방향)  
  - 역방향 조회용 레코드
  - 하나의 IP 주소에 대해 하나의 도메인 주소(PTR 레코드)만 가질 수 있음
  - 주로 화이트 도메인 구성용으로 사용함
- TXT(TeXT) 레코드
  - 도메인에 대한 설명처럼 간단한 텍스트를 입력할 수 있는 레코드
  - 화이트 도메인을 위한 SPF 레코드에 사용하기도 함

### DNS에서 알아두면 좋은 내용
- 도메인 위임
  - 자신이 가진 도메인 관리 권한을 다른 곳으로 일부 위임하고 위임한 곳에서 세부 레코드를 관리하도록 하는 방식
  - 보통 CDN을 이용하거나 GSLB를 사용함
  - 도메인은 계층구조이기 때문에 특정 계층의 레코드를 위임하면 해당 레코드의 하위 계층도 함께 위임 처리됨
  - 특정 영역에 대한 관리 주체를 분리하는 용도로 사용할수 있어서 계열사에서 특정 도메인을 분리하거나 GSLB 등 다양
- TTL(Time To Live)
  - DNS에 질의하고 응답받은 결과값을 캐시에서 유지하는 시간을 뜻함
  - TTL 값을 늘릴 수록 캐시를 많이 이용해 쿼리 응답시간과 전체적인 네트워크 응답시간이 단축됨
  - 하지만 TTL 값이 클수록 DNS에서 도메인 관련 정보가 변경되었을 때 DNS 정보 갱신이 지연된다는 단점이 있음
  - TTL 값이 너무 작으면 DNS 정보 갱신이 빨라지고 DNS 쿼리량이 늘어나 서버 부하가 증가함
  - 서비스 성질과 도메인 갱신 빈도에 따라 적절히 조절해야 함
- 화이트 도메인
  - 불법적인 방법으로 발송되는 스팸메일을 차단하기 위해 정상적인 도메인을 인증하고 관리하는 제도
  - 반대로 스팸메일 발송 사이트는 실시간 블랙리스트(RBL) 정보로 관리함
  - 도메인에 SPF 레코드(Sender Policy Framework)를 설정하고 KISA RBL 사이트에서 화이트 도메인으로 등록할 수 있음
- 한글 도메인
  - ex)http://한국인터넷진흥원.한국
  - 해당 한글을 퓨니코드로 변경하고 DNS에 도메인을 생성해야 함

### DNS 설정
- 리눅스에서는 dns를 설정하기 위해 bind 패키지를 이용함

### 호스트 파일 설정
- DNS를 이용해 도메인 주소를 IP 주소로 변환하는 방법도 있지만, 도메인과 IP주소를 매핑해놓은 hosts 파일을 변경해 도메인-IP 주소 쿼리를 사용할 수도 있음

# 7장 통신을 도와주는 네트워크 주요 기술
- DHCP (Dynamic Host Configuration Protocol)
  - 사용자가 IP 설정을 하지 않더라도 IP 주소를 자동으로 할당해주는 프로토콜
- DNS (Domain Name System)
  - 사용자가 복잡한 목적지 IP를 외우지 않고 쉬운 도메인 이름을 사용할 수 있도록 도메인 이름과 IP 주소를 매핑해주는 서비스
- GSLB(Global Service Load Balancing)
  - 사용자가 가장 가까운 지역의 데이터 센터에 접속해 신속한 서비스를 받게 해주는 서비스
- NAT (Network Address Translation)
  - 하나의 IP를 사용해 여러 단말 장비를 포함하는 네트워크를 구축하도록 도와주는 기술

## NAT/PAT
- NAT
  - 네트워크 주소 변환기술
  - IP 주소를 다른 IP 주소로 변환하는 것을 전부 NAT라고 하지만, 주로 사설 IP 주소에서 공인 IP 주소로 전환할 때 많이 사용함
  - ex) 가정에서 사용하는 노트북과 PC는 공유기로, 스마트폰은 통신사 장비를 통해서 NAT를 수행해 외부와 통신함
  - 하나의 네트워크 주소에 다른 하나의 네트워크 주소로 변환하는 1:1 변환하는 것이 기본이지만, IP 주소 고갈 문제로 여러 개의 IP를 하나의 IP로 변환하기도 함
  - NAPT(=PAT)
    - 여러 개의 IP를 하나의 IP로 변환하는 기술
 
### NAT/PAT의 용도와 필요성
1. IPv4 주소 고갈 문제의 솔루션으로 NAT 사용
  - IPv4 주소 보노 전략
    - 단기 전략: 서브네팅
    - 중기 전략: NAT, 사설 IP 체계
      - NAT 사용한 중기 전략이 IPv4 주소 보존에 큰 기여
      - 외부에 공개해야 하는 서비스에 대해서는 공인 IP를 사용하고, 외부에 공개할 필요가 없는 일반 사용자의 PC나 기타 종단 장비에 대해서는 사설 IP를 사용해 꼭 필요한 곳에만 효율적으로 사용
    - 장기 전략: IPv6 전환
2. 보안을 강화하는데 NAT 기술 사용
  - 외부와 통신할 때 내부 IP를 다른 IP로 변환해 통신하면 외부에서 사내 IP 주소 체계를 숨길 수 있음
  - 내부 네트워크에서 외부 네트워크로 나가는 통신은 허용하지만, 외부에서 내부로 들어오는 통신은 방어할 수 있음
3. IP 주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해줌
  - 공인 IP는 인터넷에서 유일한 주소로 IP 주소가 중복되면 안되지만, 사설 IP는 외부와 통신할 때 공인 IP로 변환되어 통신하므로 서로 다른 회사에서 중복 사용 가능
  - 사설 IP를 이용해 다른 회사와 직접 연결하거나 회사 간 합병으로 서로 통신해야 한다면 사설 IP 주소 충돌 발생 가능
  - IP 대역이 같은 네트워크와 통신할 가능성이 높은 대외계 네트워크(ex. 카드사, 은행 간 연결)를 연결하기 위해 출발지와 도착지를 한꺼번에 변환하는 Double NAT 기술 사용
4. 불필요한 설정 변경
  - KISA를 통해 인터넷 독립기관으로 직접 등록하고 소유한 IP 주소를 직접 운영하는 경우가 아니라면 통신사업자나 IDC 쪽에서 IP를 할당받아 사용함
    - 임시로 빌려 사용하는 것이기 때문에 회선 사업자를 바꾸거나 IDC를 이전하면 신규 사업자가 빌려주는 IP로 변경해야 함
  - NAT/PAT 기술을 적용하면, DNS 서비스나 NAT 수행 장비 설정은 변경해야 하지만 내부 서버나 PC 설정 변경을 최소화 할 수 있음
- NAT의 단점
  - 네트워크 운영자 입장에서 IP 가 변환되면 장애가 발생했을 때 문제 해결이 어려움
  - 애플리케이션 개발자 입장에서 개발 시 더 많은 고려사항이 생김
  - NAT로 주소가 변환되며 단말 간 직접적인 연결성이 무너졌고, 개발자들이 애플리케이션을 제작할 때 NAT 환경을 항상 고려해야 함

### NAT 동작 방식

![image](https://user-images.githubusercontent.com/88179702/173310943-b9e30302-c766-4329-ae67-e40613ca94b5.png)

1. 사용자가 웹서버에 접근하기 위해 출발지 IP를 10.10.10.10으로, 목적지 IP와 서비스 포트는 20.20.20.20과 80으로 패킷을 전송함(출발지 서비스 포트는 임의로 할당됨)
2. NAT 역할을 수행하는 장비에서 사용자의 패킷을 수신하고 NAT 정책에 따라 외부 네트워크와 통신이 가능한 공인 IP인 11.11.11.11로 IP 주소를 변경함
   NAT 장비에서 변경 전후의 IP 주소는 NAT 테이블에 저장됨
3. NAT 장비에서 출발지 주소를 11.11.11.11로 변경해 목적지 웹 서버로 전송함
4. 패킷을 수신한 웹서버느 사용자에게 응답을 보냄. 수신한 내용과 반대로 출발지는 웹서버(20.20.20.20), 목적지는 NAT 장비에 의해 변환된 공인 IP 11.11.11.11로 사용자에게 전송
5. 웹서버로부터 응답 패킷을 수신한 NAT 장비는 자신의 NAT 테이블에서 목적지 IP에 대한 원래 패킷을 발생시킨 출발지 IP 주소가 10.10.10.10 인 것을 확인함
6. NAT 변환 테이블에서 확인된 원래 패킷 출발지 IP(10.10.10.10)로 변경해 사용자에게 전송하면 사용자는 최종적으로 패킷을 수신함

### PAT 동작 방식

![image](https://user-images.githubusercontent.com/88179702/173311932-fdb9c934-8618-49a8-839d-7016d24d0087.png)

1. 사용자가 웹서버로 접근하기 위해 출발지 10.10.10.10, 목적지 IP와 웹서비스 포트 20.20.20.20과 80으로 패킷을 전송 (출발지 서비스 포트는 임의의 서비스 포트 할당)
2. NAT 장비는 사용자가 보낸 패킷을 받아 외부 네트워크와 통신이 가능한 공인 IP인 11.11.11.11로 변경.
   다수의 사용자가 동일한 공인 IP로 변환되어야 하므로 주소 변경 시 출발지 IP 뿐만 아니라 출발지의 서비스 포트도 변경됨. (NAT 테이블에 기록)
3. NAT 장비에서 변경된 출발지 IP 주소인 11.11.11.11과 서비스 포트 3000으로 패킷을 재작성해 웹 서버로 다시 전송함
4. 사용자가 보낸 패킷을 수신한 웹 서버는 사용자에게 패킷을 응답하는데 출발지 IP는 웹서버의 IP 주소인 20.20.20.20이고 목적지 IP는 NAT에 의해 변환된 공인 IP 11.11.11.11, 서비스 포트로 전송됨
5. 웹서버로부터 응답 패킷을 수신한 NAT 장비는 NAT 테이블을 확인해 패킷의 목적지 IP 주소인 11.11.11.11이 원래 10.10.10.10이고 서비스 포트 3000이 원래 2000인 것을 확인함
6. NAT 장비는 NAT 테이블에서 확인한 목적지 IP 주소와 서비스 포트로 패킷을 재작성한 후 사용자에게 전달함. 사용자는 NAT 장비에서 역변환된 패킷을 받아 웹페이지를 표시함

- PAT 동작 방식은 NAT와 거의 동일하게 이루어지지만, IP 주소뿐만 아니라 서비스 포트까지 함께 변경해 NAT 테이블을 관리하므로 하나의 IP만으로도 다양한 포트번호로 사용자를 구분할 수 있음
- 서비스 포트가 동시에 모두 사용중이거나 재사용할 수 없을 때에는 정상 동작하지 않기 때문에 동시 사용자가 매우 많을 때에는 공인 IP 주소를 IP 하나가 아닌 풀(Pool)로 구성해야 함
- PAT는 다수의 IP가 있는 출발지에서 목적지로 갈 때 NAT 테이블이 생성되고 응답에 대해 NAT 테이블 참조
- PAT IP가 목적지일 때는 해당 IP가 어느 IP에 바인딩되는지 확인할 수 있는 NAT 테이블이 없으므로 사용 불가
- 즉, 내부에서 외부로 출발하는 경우에만 가능함

### SNAT와 DNAT
- SNAT(Source NAT): 출발지 주소를 변경하는 NAT
  - 사설에서 공인으로 통신할 때 많이 사용함
    - 공인 IP 주소의 목적지에서 출발지로 다시 응답을 받으려면 출발지 IP 주소 경로가 필요한데 공인 대역에서는 사설 대역의 경로를 알 수 없으므로 사용함
    - 공유기처럼 PAT를 사용하는 경우
  - 보안상 사내 IP를 다른 IP로 변경하기 위해 사용함
    - 회사에서 다른 대외사와 통신시 내부의 실제 IP 주소를 숨길 수 있음
  - 로드밸런서의 구성에 따라 사용하기도 함
    - 출발지와 목적지 서버가 동일한 대역일 때는 로드밸런서 구성에 따라 트래픽이 로드 밸런서를 거치지 않고 응답할 수 있어 SNAT를 통해 응답 트래픽이 로드 밸런서를 거치게 할 수 있음
- DNAT(Destination NAT): 도착지 주소를 변경하는 NAT
  - 로드 밸런서에서 많이 사용함
    - 사용자는 서비스 요청을 위해 로드 밸런서에 설정된 서비스 VIP(Virtual IP)로 서비스를 요청하고, 로드밸런서에서는 서비스 VIP를 로드 밸런싱 될 서버의 실제 IP로 DNAT해 내보냄
  - 대외망과의 네트워크 구성에 DNAT를 사용함
    - IP 중복 문제나 IP 주소가 제각각인 문제 때문에 대외망에 NAT 장비를 이용해 대외사의 IP를 특정 IP 대역으로 NAT함

![image](https://user-images.githubusercontent.com/88179702/173316151-f15c6893-aab7-4256-9333-bf584ffe89ee.png)

- SNAT와 DNAT의 기준은 NAT가 수행되기 이전의 트래픽이 출발하는 시작 지점임

### 동적 NAT와 정적 NAT
- 동적 NAT
  - 출발지와 목적지가 사전에 정해지지 않고 NAT를 수행할 때 IP를 동적으로 변경하는 NAT
  - 최소한 출발지나 목적지 중 한곳이 다수의 IP로 구성된 IP 풀이나 레인지로 설정돼있음
  - NAT를 수행하는 시점에 IP 풀에서 어떤 IP로 매핑될 것인지를 판단하고 테이블을 만들어서 관리함
  - NAT 테이블은 설정된 시간동안 유지되고 일정 시간 통신이 없으면 사라짐 => 서비스 흐름 고려해야 함
- 정적 NAT
  - 출발지와 목적지의 IP를 미리 매핑해 고정해놓은 NAT 
  - 1:1 NAT라고도 함
  - 방향성 없이 서비스 흐름을 고려하지 않고 NAT 설정할 수 있음

## DNS
- 네트워크 프로토콜의 분류
  1. 데이터 프로토콜
     - 실제로 데이터를 실어나름
  2. 컨트롤 프로토콜
     - 데이터 프로토콜이 잘 동작하도록 도와줌
     - 통신에 직접 관여하진 않지만 처음 통신 관계를 맺거나 유지하는데 큰 역할
     - ARP, ICMP, **DNS**
 - DNS
  - 도메인 주소를 IP 주소로 변환하는 역할
  - IP 주소보다 도메인 주소를 이용하는 것이 일반 사용자에게 더 익숙하고 서버 IP 변경에 쉽게 대처 가능
  - 클라우드 기반 인프라 구성으로 인프라가 빈번히 변경되어 DNS 설계가 더욱 중요
  - MSA 기반의 서비스 설계가 많아지면서 다수의 API를 이용하다 보니 사용자의 호출 뿐만 아니라 서비스 간 API 호출이나 인터페이스가 많아져 DNS 역할이 더욱 중요

### DNS 소개
- 숫자로 구성된 IP 주소보다 의미있는 문자열로 구성된 도메인 주소가 인간이 인식하고 기억하기에 쉬움
- IP 주소 대신 도메인 주소를 이용하면 하나의 IP 주소를 이용해 여러 개의 웹서비스를 운영할 수 있고, 서비스 중인 IP 줏과 변경되더라도 도메인 주소를 유지해 접속 방법 변경 없이 서비스 유지 가능
- 지리적으로 여러 위치에서 서비스할 수 있음
- 동작 과정
  1. 사용자가 웹 브라우저에 naver.com을 입력
  2. DNS 서버에 naver.com의 주소가 무엇인지 질의하고 DNS 서버에서 naver.com의 IP 주소가 202.179.177.21임을 알려줌
  3. 사용자는 DNS로 응답받은 202.179.177.21의 IP 주소를 이용해 실제 naver.com에 접속함

### DNS 구조와 명명 규칙
- 도메인은 계층구조여서 원하는 주소를 횽ㄹ적으로 찾을 수 있음
- 역트리 구조를 사용함
- 최상위 루트, Top-Level 도메인, Second-Level 도메인, Third-Level 도메인
- 각 계층의 경계를 "."으로 표시하고 뒤에서 앞으로 해석함
- Third.second.top.
- 맨 뒤의 루트"."는 생략

![image](https://user-images.githubusercontent.com/88179702/173320071-84ca64ec-526c-4737-b43d-d0f81c1bf6c9.png)

- 도메인 계층은 최대 128계층 까지 구성할 수 있음
- 전체 도메인 네임의 길이는 최대 255바이트
- 알파벳, 숫자, "-"만 사용할 수 있고 대소문자 구분이 없음
- **루트 도메인**
  - 도메인을 구성하는 최상위 영역
  - DNS 서버는 사용자가 쿼리한 도메인에 대한 값을 직접 갖고 있거나 캐시에 저장된 정보를 이용해 응담하는데, 만약 DNS 서버에 해당 도메인의 정보가 없으면 루트 도메인을 관리하는 루트 DNS에 쿼리함
  - 루트 DNS는 전 세계에 13개가 있음
  - DNS 서버를 설치하면 루트 DNS의 IP 주소를 기록한 힌트 파일을 가지고 있어 루트 DNS 관련 정보를 별도로 설정할 필요가 없음
- **Top-Level Domain(TLD)**
  - 최상위 도메인으로 6가지 유형이 존재
  1. Generic(gTLD)
     - 특별한 제한 없이 일반적으로 사용되는 최상위 도메인
     - .com, .edu, .gov, .int, .mil, .net, .org
  2. country-code(ccTLD)
     - 국가 최상위 도메인으로 두글자의 국가 코드를 사용함
     - 우리나라는 'kr'
     - 일반 회사는 co.kr, 정부 기관은 go.kr
  3. sponsored(sTLD)  
     - 민족 공동체, 전문가 집단 등 특정 목적을 위한 스폰서를 두고 있는 최상위 도메인
     - .aero, .asia, .edu, .museum
  4. infrastructure
     - 운용상 중요한 인프라 식별자 공간을 지원하기 위해 전용으로 사용되는 최상위 도메인
     - .arpa
  5. generic-restricted(grTLD)
     - 특정 기준을 충족하는 사람이나 단체가 사용할 수 있는 최상위 도메인
     - .biz, .name, .pro
  6. test(tTLD)
     - 개발 프로세스에서 테스트 목적으로 사용하는 최상위 도메인
     - .test

### DNS 동작 방식
- 클라이언트 관점  
  - 도메인을 IP 주소로 변환하려면 DNS 서버에 도메인 쿼리하는 과정을 거쳐야 함
  - DNS 서버 없이 로컬에 도메인과 IP 주소를 직접 설정해 사용할 수 도 있음 => hosts 파일
  - DNS 캐시 정보에는 기존 DNS 조회를 통해 확인한 동적 DNS 캐시와 hosts 파일에 저장되어 있는 정적 DNS 캐시가 함께 저장돼있음
  - DNS 정보는 캐시부터 조회하므로 캐시에 존재할 경우 별도고 DNS 서버에 쿼리하지 않음
- DNS 시스템 관점
  - DNS는 분산된 데이터 베이스로 설계되어 자신이 가진 도메인 정보가 아니면 다른 DNS에 질의해 결과를 받을 수 있음
  - DNS 기능을 서버에 올리면 DNS 서버는 기본적으로 루트 DNS 관련 정보를 가지고 있음
  - 클라이언트의 쿼리가 자신에게 없는 정보라면 루트 DNS에 쿼리하고 루트 DNS에서는 쿼리한 도메인의 TLD 값을 확인해 해당 TLD 값을 관리하는 DNS를 응답함
  - 즉, 클라이언트에서 처음 질의를 받은 DNS가 중심이 되어 책임지고 루트 DNS부터 상위 DNS에 차근차근 쿼리를 보내 결과값을 알아낸 후 최종 결과값만 클라이언트에 응답함
- 전체 과정
  1. 사용자 호스트는 zigispace.net이라는 도메인 주소의 IP 주소가 로컬 캐시에 저장되어 있는지 확인함
  2. zigispace.net이 로컬 캐시에 저장돼있지 않으면 사용자 호스트에 설정된 DNS에 zigispace.net에 대해 쿼리함
  3. DNS 서버는 zigispace.net이 로컬 캐시와 자체에 설정되어 있는지 직접 확인하고, 없으면 해당 도메인을 찾기 위해 루트 NS에 .net 에 대한 TLD 정보를 가진 도메인 주소를 쿼리함
  4. 루트 DNS는 zigispace.net의 TLD인 .net을 관리하는 TLD 네임서버 정보를 DNS 서버에 응답함
  5. DNS는 TLD 네임 서버에 zigispace.net에 대한 정보를 다시 쿼리함
  6. TLD 네임 서버는 zigispace.net에 대한 정보를 가진 zigi 네임 서버에 대한 정보를 DNS 서버로 응담함
  7. DNS는 zigi 네임 서버에 zigispace.net에 대한 정보를 쿼리함
  8. zigi 네임서버는 zigispace.net에 대한 정보를 DNS 응답함
  9. DNS는 zigispace.net에 대한 정보를 로컬 캐시에 저장하고 사용자 호스트에 zigispace.net에 대한 정보를 응답함
  10. 사용자 호스트는 DNS로부터 받은 zigispace.net에 대한 IP 정보를 이용해 사이트에 접속함

![image](https://user-images.githubusercontent.com/88179702/173323474-58195fee-b6cf-4fb9-95c0-f0877af734b0.png)

### 마스터와 슬레이브
- DNS 서버는 마스터 서버와 슬레이브 서버로 나눌 수 있음
- 마스터 서버가 우선순위가 더 높은것은 아님. 두 서버 모두 도메인 쿼리에 응답함
- 마스터와 슬레이브는 도메인에 대한 zone 파일을 직접 관리하는지 여부로 구분함
- 마스터 서버
  - 존 파일을 직접 생성해 도메인 관련 정보를 관리
- 슬레이브 서버
  - 마스터에 만들어진 존 파일을 복제함 
- 영역 전송 : 슬레이브 서버에서 마스터에 만들어진 존 파일을 복제하는 것
- 마스터 서버는 자신이 가진 도메인 정보를 인가받지 않은 다른 DNS 서버가 복제하지 못하도록 슬레이브 서버를 지정해 복제를 제한 할 수 있음
- DNS 서버는 마스터 서버에 문제가 발생하고 일정 시간이 지나면 슬레이브 서버도 도메인에 대한 질의에 정상적으로 응답할 수 없음(만료 시간)

### DNS 주요 레코드
- A(IPv4) 레코드
  - 도메인 주소를 IP 주소 (IPv4)로 매핑
  - 하나의 A 레코드에는 한개의 도메인 주소와 한 개의 IP 주소가 1:1로 매핑됨
  - 동일한 도메인을 가진 A 레코드를 여러개 만들어서 서로 다른 IP 주소와 매핑할 수 있음
  - 서버 한 대에 여러 웹 서비스를 구동해야 한다면 여러 도메인에 동일한 IP를 매핑하고 HTTP 헤더의 HOST 필드에 도메인을 명시해 웹 서버를 구분해 서비스 할 수 있음 
- AAAA(IPv6) 레코드
  - 도메인 주소를 IP 주소(IPv6)로 매핑
- CNAME(Canonical Name, 별칭) 레코드
  - 도메인 주소에 대한 별칭
  - 레코드 값에 도메인 주소를 매핑함
  - 대표적인 예로 www 가 있음
- SOA(Start Of Authority, 권한 시작) 레코드
  - 본 영역 데이터에 대한 권한
  - 현재 네임서버가 이 도메인 영역에 대한 관리 주체임을 의미하므로 해당 도메인에 대해서는 다른 네임서버에 질의하지 않고 직접 응답함
- NS(Name Server) 레코드
  - 본 영역에 대한 네임 서버
  - 도메인에 대한 권한이 있는 네임 서버 정보를 설정하느 레코드임
  - 하위 도메인에 대한 권한을 다른 네임 서버로 위임하는 역할로도 많이 사용함
- MX(Mail eXchange, 메일교환기) 레코드
  - 메리 서버를 구성할 때 사용되는 레코드임
  - 우선순위 값을 이용해 다수의 MX 레코드를 선언할 수 있음
- PTR(Pointer) 레코드 
  - IP 주소를 도메인에 매핑(기본적인 A 레코드의 역방향)  
  - 역방향 조회용 레코드
  - 하나의 IP 주소에 대해 하나의 도메인 주소(PTR 레코드)만 가질 수 있음
  - 주로 화이트 도메인 구성용으로 사용함
- TXT(TeXT) 레코드
  - 도메인에 대한 설명처럼 간단한 텍스트를 입력할 수 있는 레코드
  - 화이트 도메인을 위한 SPF 레코드에 사용하기도 함

### DNS에서 알아두면 좋은 내용
- 도메인 위임
  - 자신이 가진 도메인 관리 권한을 다른 곳으로 일부 위임하고 위임한 곳에서 세부 레코드를 관리하도록 하는 방식
  - 보통 CDN을 이용하거나 GSLB를 사용함
  - 도메인은 계층구조이기 때문에 특정 계층의 레코드를 위임하면 해당 레코드의 하위 계층도 함께 위임 처리됨
  - 특정 영역에 대한 관리 주체를 분리하는 용도로 사용할수 있어서 계열사에서 특정 도메인을 분리하거나 GSLB 등 다양
- TTL(Time To Live)
  - DNS에 질의하고 응답받은 결과값을 캐시에서 유지하는 시간을 뜻함
  - TTL 값을 늘릴 수록 캐시를 많이 이용해 쿼리 응답시간과 전체적인 네트워크 응답시간이 단축됨
  - 하지만 TTL 값이 클수록 DNS에서 도메인 관련 정보가 변경되었을 때 DNS 정보 갱신이 지연된다는 단점이 있음
  - TTL 값이 너무 작으면 DNS 정보 갱신이 빨라지고 DNS 쿼리량이 늘어나 서버 부하가 증가함
  - 서비스 성질과 도메인 갱신 빈도에 따라 적절히 조절해야 함
- 화이트 도메인
  - 불법적인 방법으로 발송되는 스팸메일을 차단하기 위해 정상적인 도메인을 인증하고 관리하는 제도
  - 반대로 스팸메일 발송 사이트는 실시간 블랙리스트(RBL) 정보로 관리함
  - 도메인에 SPF 레코드(Sender Policy Framework)를 설정하고 KISA RBL 사이트에서 화이트 도메인으로 등록할 수 있음
- 한글 도메인
  - ex)http://한국인터넷진흥원.한국
  - 해당 한글을 퓨니코드로 변경하고 DNS에 도메인을 생성해야 함

### DNS 설정
- 리눅스에서는 dns를 설정하기 위해 bind 패키지를 이용함

### 호스트 파일 설정
- DNS를 이용해 도메인 주소를 IP 주소로 변환하는 방법도 있지만, 도메인과 IP주소를 매핑해놓은 hosts 파일을 변경해 도메인-IP 주소 쿼리를 사용할 수도 있음

## 7.3 GSLB
- 배경
  - DNS 로드밸런싱
    - 의미: DNS에서 동일한 레코드 이름으로 서로 다른 IP 주소를 동시에 설정하고, 도메인 질의에 따라 응답받는 IP 주소를 나누어 로드밸런싱함
    - 한계: DNS는 설정된 서비스 상태의 정상 여부를 확인하지 않고 도메인에 대한 질의에 대해 설정된 값을 무조건 응답함 => 특정 서비스(서버)에 문제가 있을 때 DNS는 이것을 감지하지 못함
    - 해결 방안: GSLB 사용
- GSLB
  - GSLB는 DNS와 동이랗게 도메인 질의에 응답해주는 역할도 하고, 로드 밸런서처럼 등록된 도메인에 연결된 서비스가 정상적인지 헬스 체크를 수행함
  - 인텔리전스 DNS라고도 부름

### GSLB 동작 방식
- GSLB를 통한 도메인 질의 흐름

![image](https://user-images.githubusercontent.com/88179702/174762634-b1c8b5fa-d7a4-4b59-8ab1-e6b20fc74e6b.png)

  1. 사용자가 web.zigispace.net에 접속하기 위해 DNS에 질의함
  2. LDNS는 web.zigispace.net을 관리하는 네임 서버를 찾기 위해 root부터 순차 질의함
  3. zigispace.net을 관리하는 네임 서버로 web.zigispace.net에 대해 질의함
  4. DNS 서버는 GSLB로 web.zigispace.net에 대해 위임했으므로 GSLB 서버가 네임 서버라고 응답함
  5. LDNS는 다시 GSLB로 web.zigispace.net에 대해 질의함
  6. GSLB는 web.zigispace.net에 대한 IP 주솟값 중 현재 설정된 분산 방식에 따라 서울 또는 부산 데이터 센터의 IP 주솟값을 DNS에 응답함
     GSLB가 응답하는 값은 GSLB에서 설정한 주기에 따라 서울과 부산 데이터센터로 헬스 체크해 정상적인 값만을 응답함
  7. GSLB에서 결괏값을 응답받은 LDNS는 사용자에게 web.zigispace.net이 1.1.1.1로 서비스하고 있다고 최종 응답함
     - 즉, GSLB는 zigispace.net이라는 FQDN에 대한 IP 주소 정보만 단순히 응답하는 게 아니라 헬스 체크를 통해 해당 IP가 정상적인 서비스가 가능한 상태인지 확인함

### GSLB 구성 방식
1. 도메인 자체를 GSLB로 사용하는 방식
  - 도메인에 속하는 모든 레코드 설정을 GSLB 장비에서 관리함
  - 도메인 구입 시 도메인에 대한 권한을 갖는 네임서버를 지정하는데, 이 네임서버가 도메인을 관리함
  - 즉, GSLB 자체가 도메인의 네임 서버 역할을 하는 것
  - 단점: 헬스체크 기능이 불필요하고, 모든 레코드에 대한 질의가 GSLB를 통해 이루어지기 때문에 GSLB에 부하를 줌
2. 도메인 내의 특정 레코드만 GSLB로 사용하는 방식
  - GSLB를 사용하려는 레코드에 대해서만 GSLB로 처리하도록 설정하는 것
  - GSLB로 처리를 이관하는 방법
    1. 별칭(Alias) 사용(CNAME 레코드 사용)
      - 실제 도메인과 다른 별도의 도메인 레코드로 GSLB에 등록됨
      - 외부 CDN을 사용하거나 회사 내부에  GSLB를 사용해야 할 도메인이 많은 경우 한꺼번에 관리하기 위해 주로 사용함
      - 과정
        1. 사용자가 웹 도메인(web.zigispace.net)의 IP 주소를 DNS로 질의함
        2. 이 질의를 받은 LDNS(Local DNS)는 root 부터 DNS 서버를 순차적으로 찾아 해당 웹 도메인을 관리하는 네임서버에 도메인의 IP 주소가 무엇인지 질의함
        3. DNS서버에는 해당 웹 도메인이 CNAME 레코드로 등록되어 있어, 이 결괏값을 LDNS 서버로 응답함
        4. 이 응답의 내용은 web.zigispace.gslb.net이 되기 때문에 LDNS는 이에 대해 다시 도메인 질의를 함
        5. 이후 다시 root부터 DNS를 순차적으로 찾아 gslb.net을 관리하는 GSLB에 질의를 하고, 그 결괏값을 LDNS가 사용자에게 최종 응답함  
    2. 위임(Delegation) 사용(네임서버 레코드 사용)
      - 실제 도메인과 동일한 레코드 도메인을 사용함
      - 도메인 전체를 위임함
      - 과정
        1. 사용자가 웹도메인(web.zigispace.net)을 LDNS로 질의
        2. LDNS는 도메인을 관리하는 NS 서버를 찾기 위해 root부터 순차적으로 질의함
        3. 해당 zigispace.net을 관리하는 DNS에 web.zigispace.net의 주소를 질의함
        4. DNS는 GSLB가 해당 도메인을 관리한다고 응답함
        5. LDNS는 도메인을 관리하는 NS 서버인 GSLB에게 도메인을 질의함
        6. GSLB는 LDNS에게 해당 웹서버의 IP를 응답하고, LDNS가 결괏값을 사용자에게 최종 응답함

### GSLB 분산 방식
- GSLB 서비스 분산의 목적
  - 서비스 제공의 가능 여부를 체크해서 트래픽을 분산함
  - 지리적으로 멀리 떨어진 다른 데이터센터에 트래픽을 분산함
  - 지역적으로 가까운 서비스에 접속해 더 빠른 서비스 제공이 가능하도록 분산함
- GSLB의 헬스 체크 모니터링 요소
  - 서비스 응답 시간/지연(RTT/Latency)
    - 서비스 요청에 대한 응답이 얼마나 빠른지, 또는 지연이 얼마나 없는지를 확인하고 이것을 이용해 서비스를 분산 처리함
  - IP에 대한 지리(Geography) 정보 
    - 서비스 제공이 가능한 각 사이트의 IP 주소에 대한 Geo 값을 확인해 가까운 사이트로 서비스 분산을 처리함
 
## 7.4 DHCP
- 배경: 네트워크 정보를호스트에 적용하려면 사용자가 IP 정보를 직접 설정하거나 IP 정보를 할당해주는 서버를 이용해 자동으로 설정해야 함
  - 정적 할당
    -  수동으로 IP와 네트워크를 직접 설정함
    -  데이터센터의 서버 팜과 같은 운영 망에서 사용되는 IP
  - 동적 할당
    - 자동으로 설정됨
    - 특별한 경우를 제외하고는 거의 동적 할당 방식을 기본으로 사용함
- DHCP
  - IP를 동적으로 할당하는 데 사용되는 프로토콜
  - 사용자가 직접 입력해야 하는 IP 주소, 서브넷 마스크, 게이트웨이, DNS 정보를 자동으로 할당받아 사용할 수 있음
  - 별도의 IP 설정작업이 필요없어 사용자와 관리자 모두 편리하게 접속 가능
  - 사용하지 않는 IP 정보는 회수되고 사용하는 경우에만 재할당되어 사용자 이동이 많고 한정된 IP 주소를 가진 경우 유용하게 사용
  - IP가 자동으로 관리되기 때문에 설정 정보 오류나 중복 IP 할당 문제 예방

### DHCP 프로토콜
- BOOTP(Bootstrap Protocol)와 DHCP
  - DHCP는 BOOTP 프로토콜을 기반으로 함
  - DHCP는 BOOTP와 유사하게 동작하지만 몇 가지 기능이 더 추가되었음
  - DHCP와 BOOTP 프로토콜은 서로 호환성이 있음

### DHCP 동작 방식
- 호스트가 DHCP 서버를 통해 신규 IP를 할당받는 과정

![image](https://user-images.githubusercontent.com/88179702/174985209-66ef5d5b-8c2d-4fa0-99c4-ecdb8c9e9292.png)

  1. DHCP Discover
    - DHCP 클라이언트는 DHCP 서버를 찾기 위해 DHCP Discover 메시지를 브로드캐스트로 전송함
    - DHCP Discover 메시지에는 DHCP 클라이언트의 IP가 아직 없으므로 출발지는 Zero IP 주소(0.0.0.0), 목적지는 브로드캐스트 주소(255.255.255.255)로 설정
    - IP를 할당받는 과정이므로 패킷을 정상적으로 주고받을 수 없어 TCP가 아닌 UDP를 사용
  2. DHCP Offer
    - DHCP Discover를 수신한 DHCP 서버는 클라이언트에 할당할 IP 주소와 서브넷, 게이트웨이, DNS 정보, Lease Time 등의 정보를 포함한 DHCP 메시지를 클라이언트로 전송함
    - 클라이언트로부터 DHCP Discover 메시지를 받은 DHCP 서버는 클라이언트에 할당할 수 있는 IP 리스트인 DHCP IP Pool 중에서 할당할 IP를 선택
    - 특정 클라이언트의 MAC 주소와 IP 주소를 사전에 정의해두면 설정된 IP를 할당하므로 DHCP를 사용하면서도 고정된 IP를 할당할 수 있음
  3. DHCP Request
    - DHCP 서버로부터 제안받은 IP 주소와 DHCP 서버 정보를 포함한 DHCP 요청 메시지를 브로드캐스트로 전송함
    - DHCP 서버 여러 대가 동작하는 환경을 위해 브로드캐스트를 사용
    - 자신이 보낸 DHCP Offer 메시지에 대한 DHCP Request인지 확인하고 그 패킷에 대해서만 응답
  4. DHCP Acknowledgement 
    - DHCP 클라이언트로부터 IP 주소를 사용하겠다는 요청을 받으면 DHCP 서버에 해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록하고 DHCP Request 메시지를 정상적으로 수신했다는 응답을 전송함
    - DHCP Request를 보낸 클라이언트에 최종 확인을 위한 응답 메시지 패킷
    - 내용은 DHCP Offer의 내용과 동일
- IP 임대 시간
  - DHCP 서버는 클라이언트에 할당할 IP 정보와 함께 임대 시간을 지정해 전달
  - 임대시간이 만료되면 클라이언트에 할당된 IP를 다시 IP Pool로 회수
  - 사용 중 임대 시간 만료될 경우
    - 클라이언트가 사용하던 IP는 다시 수거되고 클라이언트는 다시 처음부터 DHCP Discover부터 시작해 IP를 재할당받아야 함
    - 현재 클라이언트가 IP를 사용 중인 경우, 갱신(Renewal) 과정을 거쳐 사용 중인 동안 IP 주소가 IP 풀에 다시 반환되지 않고 계속 사용함
  -  클라이언트가 어느 정도 고정되어 있고 IP 풀 범위가 넓다면 임대 시간을 길게 잡는게 좋음
  -  클라이언트가 불특정하면서 자주 바뀌는 경우라면 DHCP 임대 시간을 짧게 설정해 임대된 IP가 빨리 반환되도록 해야 함
- DHCP 갱신 흐름

![image](https://user-images.githubusercontent.com/88179702/174987254-8651e6c3-de8d-4b2d-ac6c-b65962774c35.png)

  - DHCP에서 IP를 할당받은 후 임대 시간의 50%가 지나면 DHCP 갱신 과정을 수행
  - 처음 수행한 임대 과정과 달리 DHCP 서버 정보와 이미 사용 중인 IP 정보가 있어 DHCP Discover와 DHCP Offer 과정을 생략하고 DHCP Request를 DHCP로 곧바로 전송하고 DHCP 서버에서는 DHCP ACK를 보내면서 갱신 과정을 진행
  - 절차가 짧고 브로드캐스트가 아닌 유니캐스트로 진행되므로 불필요한 브로드캐스트가 발생하지 않음
  - 임대 시간이 50%가 지난 시점에서 갱신이 실패하면 남은 시간의 50%가 지난 시점, 즉 초기 임대 시간의 75%가 지난 시점에서 갱신을 다시 시도
    - 만약 이때도 갱신을 실패하면 추가 갱신 없이 임대 시간이 모두 지난 후에 IP를 반납하고 다시 처음부터 IP를 할당받음

### DHCP 서버 구성
- DHCP 서버 구성 설정 값
  - IP 주소 풀(IP 범위)
    - 클라이언트에 할당할 IP 주소 범위
  - 예외 IP 주소 풀(예외 IP 범위)
    - 클라이언트에 할당할 IP 주소로 선언된 범위 중 예외적으로 할당하지 않을 대역
  - 임대 시간
    - 클라이언트에 할당할 IP 주소의 기본 임대 시간
  - 서브넷 마스크(Subnet Mask)
    - 클라이언트에 할당할 IP 주소에 대한 서브넷 마스크 정보
  - 게이트웨이(Router)
    - 클라이언트에 할당할 게이트웨이 정보
  - DNS(Domain Name Server)
    - 클라이언트에 할당할 DNS 주소
- 리눅스에서 DHCP 서버 구성
  - dhcp 패키지 사용

### DHCP 릴레이
- 배경
  - DHCP 서버에서 IP 주소를 할당받기 위해 DHCP 클라이언트와 DHCP 서버 간에 전송되는 패킷은 모두 브로드캐스트임
  - 브로드캐스트는 동일 네트워크에서만 전송되므로 DHCP를 사용하려면 각 네트워크마다 DHCP 서버가 있어야 함
- DHCP 릴레이 에이전트(Relay Agent)
  - 여러 네트워크를 가진 환경에서도 DHCP 릴레이 에이전트(Relay Agent) 기능을 사용하면 DHCP 서버 한 대로 여러 네트워크 대역에서 IP 풀을 관리할 수 있음
  - DHCP 클라이언트와 DHCP 서버가 서로 다른 대역에 있는 경우, DHCP 패킷을 중간에서 중계(Relay)하는 역할
  - 로드캐스트로 전달되는 DHCP 패킷을 동일 네트워크 대역의 DHCP 릴레이 에이전트가 수신하면 DHCP 서버로 갈 수 있도록 이것을 유니캐스트로 변환해줌
- DHCP 릴레이 에이전트 동작 과정
  1. DHCP Discover(클라이언트 → 릴레이 에이전트)
    - 클라이언트는 DHCP 서버를 찾기 위해 브로드캐스트로 패킷을 전송
  2. DHCP Discover(릴레이 에이전트 → DHCP 서버)
    - 릴레이 에이전트는 출발지와 목적지를 릴레이 에이전트 IP 주소와 DHCP 서버 IP 주소로 재작성
    - 릴레이 에이전트가 DHCP 서버로 DHCP Discover 메시지를 보낼 때는 유니캐스트
  3. DHCP Offer(DHCP 서버 → 릴레이 에이전트)
    - 클라이언트에 할당할 IP 주소와 서브넷, 게이트웨이, DNS 정보, 임대 시간(Lease Time) 등의 정보를 포함한 DHCP 메시지를 DHCP 릴레이 에이전트로 다시 전송
    - DHCP Server Identifier는 DHCP 서버 자신
    - 유니캐스트
  4. DHCP Offer(릴레이 에이전트 → 클라이언트)
    - 릴레이 에이전트는 DHCP Offer 메시지를 DHCP 클라이언트에 브로드캐스트로 다시 전송
    - 이 때 DHCP Server Identifier는 실제 DHCP 서버의 IP 주소에서 릴레이 에이전트의 외부 인터페이스 IP 주소로 변경
  5. DHCP Request(클라이언트 → 릴레이 에이전트)
    - DHCP 서버로부터 제안받은 IP 주소(Requested IP)와 DHCP 서버 정보(DHCP Server Identifier)를 포함한 DHCP 요청 메시지를 브로드캐스트로 전송
  6. DHCP Request(릴레이 에이전트 → DHCP 서버)
    - DHCP 클라이언트에서 보낸 DHCP 요청 메시지를 유니캐스트로 다시 변환해 DHCP 서버로 전달
  7. DHCP ACK(DHCP 서버 → 릴레이 에이전트)
    - DHCP 서버는 해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록
    - DHCP Request 메시지를 정상적으로 수신했다는 응답을 전송
    - 유니캐스트
  8. DHCP ACK(릴레이 에이전트 → 클라이언트)
    - DHCP 서버에서 받은 Ack 메시지를 클라이언트에 브로드캐스트로 다시 전달
- 즉, DHCP 클라이언트와 DHCP 릴레이 에이전트 간에는 브로드캐스트로 동작하고 다시 DHCP 릴레이 에이전트와 DHCP 서버 간에는 유니캐스트로 동작
- DHCP 릴레이 에이전트는 DHCP 클라이언트와 같은 L2 네트워크 내에 존재해야 하며 DHCP 서버에는 유니캐스트로 전달하기 위해 DHCP 서버의 IP 주소가 등록되어 있어야 함

