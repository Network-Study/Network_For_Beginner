# 9장 보안
## 9.1 보안의 개념과 정의
- 보안: 위험이 생기거나 사고가 날 염려 없이 편안하고 온전한 상태를 지키는 활동
- IT 보안 분야: '정보 보안'

### 정보 보안의 정의
- 의미
  - 외부에서 정보가 저장된 시스템을 사용하지 못하게 하거나 유출 시도에 맞서서 적절히 보호하는 것
  - 운영하기 위한 작업과 정보가 내부에서 유출되거나 남용되는 것을 막기 위한 것
- 보안의 필수 요소
  - 기밀성
    - 인가되지 않은 사용자가 정보를 보지 못하게 하는 모든 작업
    - ex) 암호화 작업
  - 무결성
    - 정확하고 완전한 정보 유지에 필요한 모든 작업
    - 누군가 정보를 고의로 훼손하거나 중간에 특정 이유로 변경이 가해졌을때 그것을 파악해 잘못된 정보가 전달되거나 유지되지 못하게 하는 것
    - ex) MD5, SHA처럼 해시 함수를 이용하는 것
  - 가용성
    - 정보가 필요할 때 접근을 허락하는 일련의 작업
  - 그 외) 진정성, 책임성, 부인방지, 신뢰성

### 네트워크의 정보 보안
- 정보를 가진 시스템을 공격해 유출하거나 사용하지 못하게 하거나 시스템이 동작하지 못하게 해 정보 서비스를 정상적으로 구동할 수 없게 만드는 행위를 네트워크에서 막는 것
- 여러 서비스를 제공하기 위해 정보는 네트워크를 통해 복제, 이동되므로 그 유출을 막는 것
- 네트워크 보안은 BOTTOM-UP 형식으로 발전중

### 네트워크 보안의 주요 개념
- 네트워크 보안의 목표
  - 외부 네트워크로부터 내부 네트워크를 보호하는 것
- 정보 보안별 네트워크 종류
  - 트러스트 네트워크: 외부로부터 보호받아야 할 네트워크
  - 언트러스트 네트워크: 신뢰할 수 없는 외부 네트워크
  - DMZ 네트워크: 운영하는 내부 네트워크이지만 신뢰할 수 없는 외부 사용자에게 개방해야 하는 서비스 네트워크(인터넷에 공개되는 서비스)
- 네트워크 보안 분야
  - 인터넷 시큐어 게이트웨이
    - 트러스트(또는 DMZ) 네트워크에서 언트러스트 네트워크로의 통신을 통제
    - 인터넷에 수많은 서비스가 있으므로 그에 대한 정보와 요청 패킷을 적절히 인식하고 필터링 하는 기능
    - 종류: 방화벽, SWG(Secure Web Gateway), 웹 필터, 애플리케이션 컨트롤, 샌드박스
  - 데이터 센터 시큐어 게이트웨이
    - 언트러스트 네트워크에서 트러스트(또는 DMZ)로의 통신을 통제
    - 상대적으로 고성능으로, 외부의 직접적인 공격을 막아야 하므로 공격관련 정보가 중요
    - 종류: 방화벽, IPS, DCSG(DataCenter Secure Gateway), WAF(Web Application Firewall), Anti-DDos
  - 네트워크 보안 정책 수립에 따른 분류
    - 화이트리스트
      - 방어에 문제가 없다고 명확히 판단되는 통신만 허용하는 방식
      - 주로 회사 내부에서 사용하는 방화벽이 화이트리스트 방식을 주로 사용
    - 블랙리스트
      - 공격이라고 명확히 판단되거나 문제가 있었던 IP 리스트, 패킷 리스트를 기반으로 데이터베이스를 만들고 그 정보를 이용해 방어하는 방식
      - 각종 패턴으로 공격을 방어하는 네트워크장비(IPS, 안티바이러스, WAF)들은 일반적으로 블랙리스트 기반의 방어 기법을 제공
    - 대부분의 장비는 수립 정책에 따라 화이트리스트, 블랙리스트 기법을 모두 사용할 수 있음
    - 최근 보안 위협이 증가하며 화이트리스트 기반 정책을 많이 사용함
-정탐, 오탐, 미탐(탐지 에러)
  - IPS나 안티바이러스 같은 네트워크 장비에서는 공격 데이터베이스에 따라 공격과 악성코드를 구분해 방어함
  - 블랙리스트 기반 DB를 이용한 방어의 문제점
    - 공격을 받아도 공격으로 탐지하지 못하거나, 공격이 아닌데도 공격으로 감지하는 경우가 있음
  - 오탐지, 미탐지 => 공격을 탐지할 때 원래 예상한 내용과 다른 결과
  - 정탐 => 정상 탐지된 결과

| - |공격 상황|정상 상황|
|---|---|---|
|공격 인지|정상 탐지|오 탐지|
|정상 인지|미 탐지|정상 탐지|

  1. 공격이라고 추론했는데(Yes), 실제로 공격인 경우(Yes): True Positive(정탐)
  2. 공격이 아니라고 추론했는데(No), 실제로 공격이 아닌 경우(No): False Negative(정탐)
  3. 공격이라고 추론하고 패킷을 드롭했는데(Yes), 공격이 아닌 경우(No): False Positive(오탐)
  4. 공격이 아니라고 추론하고 패킷을 허용했는데(No), 공격인 경우(Yes): True Negative(미탐)

### 네트워크 정보 보안의 발전 추세와 고려사항
- 보안 영역 외부의 변화로 발전하는 경우
  - 인프라스트럭처나 서비스의 대변화로 인해 보안이 따라서 발전해야 하는 경우
- 보안 영역 내부의 변화로 발전하는 경우
  - 해킹 기술의 발전에 대응하다보니 발전
  
## 9.2 보안 솔루션의 종류
- 네트워크 보안 장비 구성 단계
  - DDos 방어 장비(프로파일링) -> 방화벽(포트 제어) -> IPS(시그니처) -> 웹 방화벽(WAF)(시그니처) -> 서버

### DDos 방어 장비
- DoS(Denial of Service)
  - 공격 목표에 서비스 부하를 가해 정상적인 서비스를 방해하는 공격 기법
  - 적이 공격 출발지에서 공격하는 것이 일반적이었기 때문에 비교적 탐지가 쉽고, 짧은 시간안에 탐지한다면 IP 주소 기바으로 충분히 방어 가능
- DDoS
  - DoS에서 탐지를 회피하고 더 짧은 시간 안에 공격 성과를 내기 위해 다수의 봇을 이용해 분산공격을 수행하는 기법
- DDoS 장비
  - DDoS 공격을 방어하는 보안 장비

### 방화벽
- 4계층에서 동작하는 패킷 필터링 장비
- 일반적으로 DDoS 방어 장비 바로 뒤에 놓음
- 3,4계층에서 동작하므로 다른 보안 장비보다 비교적 동작이 간단하고 성능도 우수

### IDS, IPS
- IDS(침입 탐지 시스템), IPS(침입 방지 시스템)
  - 사전에 공격 데이터베이스를 제조사나 위협 인텔리전스 서비스 업체로부터 받음
  - 장비에 들어온 패킷이 보유한 공격 데이터베이스에 해당하는 공격일 때 차단하거나 관리자에게 공격 시도를 알림

### WAF
- 웹서버를 보호하는 전용 보안 장비
- HTTP, HTTPS처럼 웹 서버에서 동작하는 웹 프로토콜의 공격을 방어함
- 제공 형식
  - 전용 네트워크 장비
  - 웹 서버의 플러그인
  - ADC vmffjrmdls
  - vmfhrtl wkdql vmffjrmdls
- IPS에서 방어할 수 없는 IPS 회피 공격을 방어할 수 있음

### 샌드박스
- 진화한 공격 방법에 대한 대응
  - 직접적으로 공격을 할 서버에 접근하지 않고, 악성 코드를 관리자 PC에 우회적으로 심고, 이 악성 코드를 이용해 관리자 PC를 컨트롤 하는 방식
  - 기존 방화벽에서는 내부 사용자가 외부 서버로 통신을 정상 시도한 것으로 보므로 공격을 검출하거나 방어할 수 없음
- 샌드박스 방식
  - 악성코드를 샌드박스 시스템 안에서 직접 실행시킴
  - 가상 운영체제 안에서 각종 파일을 직접 실행시키고 행동을 모니터링해 파일들의 악성코드 여부를 판별함

### NAC
- 네트워크에 접속하는 장치들을 제어하기 위해 개발됨
- 인가된 사용자만내부망에 접속할 수 있고 인가받기 전이나 승인에 실패한 사용자는 접속할 수 없도록 제어함

### IP 제어
- 보안사고 추적이 쉽고, 고정 IP를 사용하며 IP를 할당하고 추적하는 솔루션
- 할당된 IP를 관리하고, 정확히 의도된 IP 할당들이 아니면 정상적으로 네트워크를 사용ㅎ지 못하게 하는 기능

### 접근 통제
- 서버나 데이터베이스에 대한 직접적인 접근을 막고 추가 작업 및 감사를 할 수 씨는 통제 솔루션
- 종류
  - 에이전트 기반
  - 에이전트 리스
  - 배스천 호스트 기반
    - 서버 호스트의 방화벽에 배스천 호스트에서 출발한 통신만을 허용하고, 나머지 통신은 모두 방어하도록 설정
    - 이 기법을 발전시킨 것이 현재의 접근통제/감사 솔루션임
    
![image](https://user-images.githubusercontent.com/88179702/177121849-1b1ef872-1e91-4d19-8143-3343e4a4a4ad.png)

### VPN
- 사용자 기반의 VPN 서비스를 제공해주는 장비
- VPN 장비의 일반적인 구성
  - 서버ㅡVPNㅡ인터넷ㅡVPNㅡ서버
- 주로 사용하는 VPN
  - IPSEC, SSL

## 9.3 방화벽
- 네트워크 보안 장비 중 가장 유명하고 대중적인 필수 장비

### 방화벽의 정의
- 네트워크 중간에서 해당 장비를 통과하는 패킷을 판별해 허용하거나 차단함
- 일반적으로 3, 4계층에서 동작하며, 세션을 인지하는 상태 기반 엔진으로 동작함

### 초기 방화벽
- 초기 방화벽은 패킷의 인과 관계를 확인하지 못하고 장비에 등록된 정책만으로 단순하게 패킷을 필터링 했음
- 패킷의 세션 정보나 방향성과 상관없이 순수하게 방화벽에 설정된 정책에 따라 동작함
- 스테이트리스, 패킷 필터 방화벽이라고 함
- 참고 조건: 5튜플
  - Source IP, Destination IP, Protocol No, Source Port, Destination Port
- 방화겨에 일치된 정책이 있으면 해당 정책에 따라 그 패킷을 허용하거나 차단함
- 단점
  - 인터넷 통신처럼 불특정 다수 기반의 정책을 정의할 때는 룰셋이 복잡해지고 보안이 약화됨
  - 패킷 단위 필터링이기 때문에 5튜플 외의 3,2,계층 헤더를 변조해 공격하면 방어가 불가능함

### 현대적 방화벽의 등장(SPI 엔진)
- 세션 기반으로 동작하는 상태 기반(SPI)엔진을 탑재함
- SPI 엔진을 사용하면 패킷의 인과 관계와 방향성을 인지해 정책을 적용할 수 있음
  - 내부 네트워크에서 인터넷으로 통신할 때 유용하게 사용함

### 방화벽 동작 방식
- 방화벽이 패킷을 처리하는 순서
  1. 장비에 패킷이 들어오면 세션 상태 테이블을 확인함
  2. 조건에 맞는 세션 정보가 세션 테이블에 있을 때, 포워딩 테이블을 확인함(라우팅, ARP 포함)
  3. 조건에 맞는 세션 정보가 세션 테이블에 없을 때, 방화벽 정책을 확인함
  4. 맨위의 정책부터 최종정책까지 방화벽 정책을 확인한 후, 없을 경우 암시적 거부 규칙을 참고해 차단함
  5. 있을 경우, 내용을 세션 테이블에 적음
  6. 포워딩 테이블을 확인함
  7. 조건에 맞는 정보가 포워딩 테이블에 있을 때, 적절한 인터페이스로 패킷을 포워딩함
  8. 조건에 맞는 정보가 포워딩 테이블에 없을 때, 패킷을 폐기함
- SPI 엔진을 가진 방화벽은 세션 인지 기능이 있어 단순히 5튜플 조건만 확인하는 것이 아니라 OSI3,4계층의 세부적인 필드도 함께 확인함

### ALG
- FTP의 기본적인 동작 순서
  1. 클라이언트는 랜덤포트 2000을 통해 서버 커맨드 포트 21에 접속하고, 데이터 포트로 사용할 2001(n+1)번 포트 정보를 서버에 전송함
  2. 서버에서 클라이언트의 커맨드포트(21)에 응답함
  3. 서버는 서버의 데이터 포트(20)르르 클라이언트의 데이터 포트(2001)에 접속한다.
  4. 클라이언트에서 서버의 데이터 포트에 응답한다
- FTP 액티브 모드에서는 초기 접속 방향과 반대로 데이터 프로토콜이 동작함 =>방화벽을 정상적으로 통과할 수 없음
- 방화벽에 FTP 액티브 모드를 통과시키기 위해 애플리케이션 프로토콜을 확인하고, 필요에 따라 세션을 인지해 포트를 자동으로 열어주는 ALG(Application Layer gateway) 기능 사용
- FTP 프로토콜이 방화벽을 지나갈 때의 방화벽 동작 순서
  1. FTP ALG 기능은 초기 FTP 요청 커맨드를 모니터링함
  2. 서버쪽에서 사용할 데이터 세션에서 사용할 포트를 클라이언트로 알려줄 때, 이 정보를 확인하고 적절한 세션 정보를 만듦
     서버의 출발지 IP와 포트는 TCP 20버으로, 클라이언트의 IP와 서버에서 알려준 포트를 도착지로 하는 세션을 만들어 세션 테이블에 올림
  3. 서버에서 클라이언트로 데이터 세션을 열 때, 세션 테이블에 이미 정보가 들어 있어 정책을 확인하지 않고 패킷을 포워딩함

### 방화벽의 한계
- 방화벽으로 인해 공격 목표가 시스템이나 계정 탈취에서 서비스 중단쪽으로 바뀌고, DDoS 공격이 새로운 트렌드가 됨
- 대규모 웜 공격으로 인터넷 서비스가 마비되며 방화벽의 한계가 드러남
- 웜공격을 막기 위해 등장한 보안 장비가 IPS

## 9.4 IPS, IDS
- 방화벽은 네트워크 보안을 위한 필수 솔루션이지만 3,4계층 방어만 가능하므로 애플리케이션 계층 공격은 방어할 수 없음
- 애플리케이션 계층의 공격을 탐지, 방어하기 위해 IDS, IPS가 개발됨

### IPS, IDS의 정의
- IDS(Intrusion Detection System, 침입 탐지 시스템)
  - 공격자가 시스템을 해킹할 때 **탐지**를 목적으로 개발된 시스템  
  - 방어보다 탐지에 초점을 맞추어 개발되어, 공격에 직접 개입하거나 방어하는 것이 아니라 트래픽을 복제해 검토하고 침입 여부를 판별함
- IPS(Intrusion Prevention System, 침입 방지 시스템)
  - 공격이 발견되면 직접 **차단**하는 능력을 갖춘 장비
  - 트래픽을 복제해 검토만 하는 것이 아니라 트래픽이 지나가는 인라인 상에 장비를 배치함
  - 호스트 기반 IPS, 네트워크 기반 IPS가 있지만 일반적으로 IPS는 네트워크 기반 NIPS임

### IPS, IDS의 동작 방식
- 패턴 매칭 방식
  - 블랙리스트 기반 방식  
  - 기존 공격이나 취약점을 통해 공격방식에 대한 데이터베이스를 습득하고, 그 최신 내용을 유지하다가 공격을 파악하는 기술
  - 많은 공격 데이터 베이스를 보유해야 하고, 최신 공격방식을 공격 데이터베이스에 최대한 신속히 반영해야 함
  - 실제로 공격이 들어오기 전에 해당 공격에 대한 패턴 데이터베이스가 확보되어 있어야 함
    - 극미한 변화만 생겨도 적절한 대응이 어렵고, 웜 공격 변종을 막아내기가 어려웠음
- 어노말리 공격 방어
  - 화이트리스트 기반 방식
  - 분명한 공격으로 파악되지 않더라도 특정 기준 이상의 행위를 이상하다고 판단하고 방어함
  - 프로파일 어노말리
    - 평소 관리자가 정해놓은 기준이나 IPS 장비가 모니터링해 정해진 기준과 다른 행위가 일어나면 공격으로 판단함
    - ex) 평소 1MB 이하의 트래픽이 발생하던 프린터트 서버에 수십 MB 이상의 트래픽이 발생한 경우
    - 동적 프로파일 기능이 강화되면서 향후 DDoS 방어 장비로 진화함
  - 프로토콜 어노말리
    - 잘 알려진 포트와 실제로 통신하는 프로토콜이 다를 때, 이것을 파악해 적절히 제어하는 기법
    - ex)감염된 내부 PC가 외부와 공격을 위한 통신을 할 때는 잘 알려진 서비스 포트를 사용하지만, 실제 해당 서비스 포트에서 동작하는 프로토콜이 아닌 다른 프로토콜을 사용하는 경우 이를 의심함
  
### IPS, IDS의 한계와 극복(NGIPS)
- 한계
  - 네트워크상에서 빠른 속도로 애플리케이션 레벨까지 확인하기 위해 플로 엔진을 사용함
    - 플로 엔진은 패킷을 모아 데이터 형태로 변환해 검사하는 것이 아니라, 패킷이 흘러가는 상황을 모니터링해 공격을 탐지하기 때문에 IPS 장비를 비교적 쉽게 우회할 수 있음
  - 오탐이 많이 발생하기 때문에, 초기 설치 환경에 맞는 튜닝작업을 오래 해주어야 하고, 별도의 관제 인력이 장비를 모니터링하고 환경에 맞는 최적화 작업을 지속적으로 수행해야 함
- 극복
  - NGIPS(Next Generation IPS) 장비 출시
    - 애플리케이션을 인지하거나 다양한 시스템과 연동할 수 있고, APT 공격을 방어하기 위한 일부 기능이 탑재되어 있거나 다양한 외부 시스템과 연동 가능

## 9.5 DDoS 방어 장비
- DDoS
  - 방화벽 대중화 이후의 공격
  - 정상적인 서비스가 불가능 하도록 방해함
  - 다수의 공격자를 만들어 동시에 DoS 공격을 하는 분산형 DoS
### DDoS 방어 장비의 정의
- 다양한 DDoS 공격을 방어하기 위한 DDoS 전용 방어 장비
- 볼류메트릭 공격을 방어하기 위해 트래픽 프로파일링 기법을 주로 사용
- 인터넷의 다양한 공격 정보를 수집한 데이터베이스를 활용하기도 함

### DDoS 방어 장비 동작 방식
- DDoS 방어 서비스
  - 클라우드 서비스, 회선 사업자의 방어 서비스, DDoS 방어 장비를 사내에 설치하는 방법
  - 주로 DDoS 공격을 탐지해 공격을 수행하는 IP 리스트를 넘겨주면 방어장비나 ISP 내부에서 이 IP를 버리는 것이 가장 흔한 DDoS 방어 기법임
  - 인라인 방식: 탐지 및 방어를 하나의 장비에서 함
  - 아웃 오브 패스 방식: 탐지 및 방어를 다른 장비에서 수해함
- DDoS 여부를 판별하는 방식
  - 프로파일링 기법
    - 평소 데이터 흐름을 습득해 일반적인 대역폭, 세션량, 초기접속량, 프로토콜별 사용량 등을 저장함
    - 습득한 데이터와 일치하지 않는 과도한 트래픽이 인입되면 알려주고 차단함
  - 데이터베이스 기반 방어
    -  IP 평판 데이터베이스를 공유해 DDoS 공격으로 사용된 IP 기반으로 방어 여부를 결정하거나 특정 공격 패턴을 방어함

### DDoS 공격 타입
- 볼류매트릭 공격
  - 회선 사용량을 가득채우는 공격
  - 공격에 의해 생성된 트래픽 양이 최종자원(웹사이트 또는 서비스)에 대한 액세스를 완전히 차단함
  - 쓸모없는 패킷이 회선을 모두 차지해 정상적인 서비스 트래픽이 통과할 수 없음
  - ex) NTP 증폭, DNS 증폭, UDP 플러드, TCP 플러드
- 프로토콜 공격
  - 3,4계층의 취약점과 리소스 고갈을 노리는 공격
  - 공격 대상이나 중간 위험 리소스의 처리 용량을 모두 사용해 서비스 중단을 유발함
  - 공격 장비의 CPU, 메모리 자원을 고갈시켜 정상적인 서비스가 불가능하게 함
  - ex) Syn 플러드, Ping of Death
- 애플리케이션 공격
  - 애플리케이션의 취약점을 주로 노림
  - 가장 정교하고 까다로운 공격
  - 대상과의 연결을 설정한 후, 프로세스와 트랜잭션을 독점해 서버 자원을 소모시킴
  - ex) HTTP 플러드, DNS 서비스 공격, Sloworis 등

### 볼류매트릭 공격
- 회선 사용량이나 그 이상의 트래픽을 과도하게 발생시켜 회선을 사용하지 못하도록 방해하는 공격
- 회선을 공급해주는 ISP 내부나 사용자 네트워크 최상단에 위치시켜 공격을 완화해야 함
- 좀비 PC를 이용한 볼류메트릭 공격
  - 특정 시간에 특정 타깃을 공격해야 하기 때문에, 미리 악성 코드에 감염되어 해커가 컨트롤 할 수 있는 좀비 PC를 많이 확보해 두어야 함
- DDoS 혼자서는 대부분 방어가 불가능 하기 때문에 ISP 를 통한 방어나 Cloud DDoS 솔루션을 통해 서비스 네트워크로 트래픽이 직접 도달하지 못하도록 조치해야 함
- 클라우드 기반 서비스의 최대 장점은 실제 서비스 네트워크가 가려지므로 네트워크 차원이나 대규모 볼류메트릭 공격도 큰 투자 없이 방어할 수 있음

## 9.6 VPN
- VPN(Virtual Private Network)
- 물리적 전용선이 아닌 공중망을 이용해 논리적으로 직접 연결한 것처럼 망을 구성하는 기술
- VPN 기술에서는 인터넷이라는 공용망을 이용해야 하므로 안전하게 통신할 수 있도록 암호화와 인증과 같은 보안 강화 기술을 적용해야 함
- 본사-지사 처럼 네트워크 대 네트워크 연결에는 IPSEC VPN 기술을 사용
- 개인 사용자가 본사 네트워크로 접속하는 경우에는 SSLVPN 기술을 사용

### VPN 동작 방식
- 가상 네트워크를 만들어주는 장비로 터널링 기법을 사용함
- 터널링 기법: 패킷을 터널링 프로토콜로 감싸 통신하는 기법
- VPN의 형태
  - Host to Host 통신 보호
    - 두 호스트 간에 직접 VPN 터널을 연동하는 기법
    - 잘 사용하지 않음
  - Network to Network 통신 보호
    - 본사-지사 같은 특정 네트워크를 가진 두 종단을 연결하는 경우
    - IPSEC 프로토콜 스택을 주로 사용함
  - Host가 Network로 접근할 때 보호
    - 모바일 사용자가 일반 인터넷망을 통해 사내망으로 연결하는 경우
    - IPSEC과 SSL 프로토콜이 주로 사용됨
- 사이트르르 우회하는 기법으로 많이 사용되지만, 공중 무선망을 사용할 때 해커의 공격을 암호화 기법으로 원천방어 할 수 있음. 
