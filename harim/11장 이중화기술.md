# 11장 이중화 기술
## 11.1 이중화 기술 개요
- 이중화를 하지 않을 경우 SPoF 문제점이 발생함

### SPoF (단일 장애점)
- 시스템 구성 요소 중 동작하지 않으면 전체 시스템이 중단되는 요소
- ex) 이더넷 케이블과 전원, 이더넷 허브, 접속 단말들의 NIC으로 이뤄진 간단한 이더넷 네트워크 시스템에서는 네트워크 허브 장치의 전원이 SPoF임
  - 허브의 전원이 차단됨가 동시에 나머지 모든 요소는 네트워크를 사용할 수 없기 때문
- 인프라의 목표
  - 적시에 서비스를 출시하기 위해 인프라를 신속히 제공하는 것
    - 타임 투 마켓을 위한 인프라의 민첩성
  - **더 가용성 높은 서비스에 필요한 인프라를 안정적으로 제공하는 것**
    - 따라서 인프라를 설계할 때, 단일 접점의 장애가 전체 서비스에 영향을 미치지 않도록 SPoF(단일 장애점)를 만들지 않아야 함
    - SPoF는 전체 서비스의 가용성, 연속성, 안정성을 떨어뜨리는 위험한 요소이기 때문에 SPoF가 아예 만들어지지 않게 설계하는 것이 좋은 인프라 설계임

### 이중화의 목적
- 안정적인 서비스 제공을 위해 네트워크를 포함한 모든 인프라에서 반드시 갖추어야 할 요소
- 인프라를 구성하는 각 요소가 복수 개 이상으로 인프라를 구성해, 특정 인프라에 문제가 발생하더라도 이중화 된 다른 인프라를 통해 서비스가 지속되도록 해줌
- 고려할 이중화 구성
  - 서비스를 위한 물리적 또는 가상 머신 서버
  - 서버와 네트워크 장비를 구성해주는 인터페이스
  - 서버에 연결된 스위치
  - 다수 서버의 부하 분산을 위한 L4/L7 스위치
  - 방화벽, 인터넷 게이트웨이, 인터넷 회선 등
  - 데이터센터 또한 DR 센터(Disaster Recovery Center)나 액티브-애기브 데이터 센터로 구축함
- 이중화 구성 형태
  - 액티브-액티브 형태
    - 각 구성 요소가 동시에 운영중인 상태로 동작
    - 서비스 요청을 동시에 처리할 수 있으므로 처리 가능한 전체 용량이 증가함
    - 다만, 증가된 인프라 용량을 기준으로 삼아 서비스를 수용하면, 특정 지점에 장애가 발생했을 때 인프라 용량이 절반으로 떨어지므로 정상 서비스가 불가능함
  - 액티브-스탠바이 형태  
    - 하나의 구성 요소는 운영 상태이고 다른 하나는 대기 상태로 있다가, 운영 상태인 인프라에 장애가 발생하면 운영 상태로 전환됨
- 인프라를 이중화 해야 하는 이유
  - 특정 지점에 문제가 발생하더라도 이중화된 인프라를 이용해 서비스 할 수 있음
  - 특정 인프라의 장애 상황에서도 서비스는 가능하므로, 서비스의 연속성이 보장되고 폴트 톨러런스(Fault Tolerance, 장애 허용)가 보장됨
## 11.2 LACP
- LACP란
  - Link Aggregation Control Protocol
  - 호환성 문제를 해결하기 위해 상호 호환 가능하도록 한 연결 계층 표준화
  - 다수의 물리 인터페이스를 하나의 논리 인터페이스로 구성하는 방법
- LACP 목적
  - 링크 사용률 향상
  - 향상된 장애 극복

### LACP 동작 방식
- LACPDU(LACP Data Unit)
  - LACP를 통해 장비 간 논리 인터페이스를 구성하기 위해 사용하는 프레임
  - LACP를 구성하기 위한 출발지 주소, 목적지 주소, 타입, 서브 타입, 버전 정보등을 포함해 매초 마다 주고받음
  - 멀티캐스트를 이용하고 목적지 주소는 01:80:c2:00:00:02부터 01:80:c2:00:00:10까지 사용
- LACP 구성은 장비 간 1:1 구성에서만 가능함
- LACP는 두 장비 모두 LACP 설정을 하고 LACPDU를 주고받아야 가능함
- LACP 모드
  - 액티브 모드
    - LACPDU를 먼저 송신하고, 상대방이 LACP로 구성된 경우 LACP를 구성함
  - 패시브 모드
    - LACPDU를 송신하진 않지만 LACPDU를 수신받으면 응답하고 LACP를 구성함
  - 보통 액티브 옵션을 사용함
  - 액티브-액티브, 액티브-패시브 일 때는 LACP가 구성가능하지만 패시브-패시브 일땐 LACP 연결이 되지 않음

### LACP와 PXE
- LACP로 구성하려는 서버를 PXE로 운영체제를 설치할 때는 LACP 인터페이스가 아닌 일반 인터페이스로 구성해 운영체제를 설치하고, 운영체제에서 LACP 설정을 다시 한 후 스위치 포트 설정을 다시 변경해야 함
- 초기 운영체제 구성 전에는 서버에서 LACPDU를 보낼 수 없기 때문임
- 운영체제가 서버에 정상적으로 설치한 후 LACP 설정을 하고 서버에서 LACPDU를 보내 스위치와 서버를 LACP로 구성함

## 11.3 서버의 네트워크 이중화 설정
- LACP 설정 부분에서 인터페이스 이중화에 사용되는 기술 명칭
  - 윈도우: 팀/team/티밍/teaming
  - 리눅스: 본드/bond/본딩/bonding
- 서버 인터페이스를 이중화 하면 네트워크 장비와 마찬가지로 논리 인터페이스가 생성됨
- 서버의 인터페이스 이중화 구성은 네트워크 인터페이스 이중화와 다름

|구분|윈도우|리눅스|
|---|---|---|
|기술명|티밍|본딩|
|인터페이스명|team #1, #2|bond 0, bond 1|
|동작 모드|Switch Independent, LACP, Static Teaming|0:라운드 로빈 1:액티브-스탠바이 2:balance-xor 3:브로드캐스트 4:LACP|

### 리눅스 본딩 모드
- 0~4까지 존재
- 대부분 모드1, 모드4만 사용함
- 모드 1: 액티브-스탠바이
  - 평소 액티브 인터페이스로만 패킷이 전달되지만, 액티브가 죽으면 스탠바이 인터페이스가 자동으로 활성화되어 패킷을 전송함
  - 원래의 액티브 인터페이스가 다시 살아나면 설정에 따라 액티브 인터페이스가 자동으로 다시 활성화되거나, 수동으로 넘기기 전까지 스탠바이 인터페이스가 활성화 상태를 유지함
- 모드 4: LACP (액티브-액티브)
  - 액티브-액티브 모드

### 윈도우 티밍 모드
- 총 7까지가 있지만 주로 두가지만 사용함
- 스위치 독립 구성 모드
  - 팀을 구성하는 멤버인터페이스가 스위치 구성에 독립적임
  - 스위치에서는 팀의 이중화에 관여하지 않는 구성
  - 액티브-스탠바이 구성
- LACP 모드
  - 리눅스의 모드 4와 동일한 LACP 구성
  - 액티브-액티브로 구성할 때 사용

## 11.4 MC-LAG
- LACP를 구성할 때 LACPDU를 주고 받는 장비 상호 간 구성이 1:1 이어야 함 -> LACP 구성 시 MAC 주소가 1:1 이어야 한다는 의미
- 이중화 구성을 할 때 각 NIC 별로 MAC 주소를 따로 사용하지 않고 여러 MAC 주소 중 하나를 Primary MAC 주소로 사용함
- MC-LAG 기술
  - 서로 다른 스위치 간의 실제 MAC 주소 대신 가상 MAC 주소를 만들어 논리 인터페이스로 LACP를 구성함
  - 서버 이중화 구성처럼 서로 다른 스위치 간의 단일 MAC 주소를 사용해 액티브-액티브 형태로 이중화 구성을 하는 것
  - 단일 스위치로 LACP를 구성해 대역폭을 확장할 것인지, 서로 다른 스위치로 구성해 장비 이중화로 가용성을 확보할 것인지를 선택할 수 있음

### MC-LAG 동작 방식
- MC-LAG의 구성요소
  - 피어 장비
    - MC-LAG을 굿ㅇ하는 장비
  - MC-LAG 도메인
    - 두 Peer 장비를 하나의 논리 장비로 구성하기 위한 영역 ID
    - Peer 장비는 이 영역 ID를 통해 상대방 장비가 Peer를 맺으려는 장비인지 판단함
  - 피어 링크
    - MC-LAG을 구성하는 두 Peer 장비 간의 데이터 트래픽을 전송하는 인터링크
- MC-LAG 구성 방법
  - 피어 링크를 이용한 제어 패킷 전송
    - 각 피어의 VLAN 인터페이스의 IP를 설정하고, 이 IP를 이용해 통신함
  - 별도 인터페이스로 제어 패킷 전송
    - 해당 인터페이슬르 L3 인터페이스로 구성해 이 인터페이스의 IP를 이용해 통신함
  - 기본 설정
    - 피어에 동일한 도메인 ID 설정
    - 피어 간의 데이터 트래픽 전송을 위한 피어 링크 설정
    - 피어 간의 제어 패킷 전송을 위해 피어끼리 통신 가능한 IP 설정
- MC-LAG이 설정된 스위치가 LACP를 통해 이중화 구성을 하는 동작 방식
  - 두 장비 간에 LACP를 구성할 때는 각 장비의 MAC 주소가 출발지의 MAC 주소가 됨

### MC-LAG을 이용한 디자인
1. MC-LAG을 이용해 서버를 연결하면 스위치를 물리적으로 이중화하면서 액티브-액티브 구성으로 연결할 수 있음
  - 스위치 두대를 한 대로 인식
2. 스위치 간의 MC-LAG을 이용하면 루프 구조가 사라지므로 STP에 의한 차단 포트 없이 모든 포트를 사용할 수 있음
3. 스위치 간의 MC-LAG을 구성하는 또 다른 경우로, 상/하단을 모두 MC-LAG으로 구성하는 디자인
  - MC-LAG을 양쪽에 모두 적용해 스위치 4대를 1:1 구조로 구성할 수 있음

## 11.5 게이트웨이 이중화
### 게이트웨이 이중화란?
- 특정 호스트가 동일한 서브넷에 있는 내부 네트워크와 통신할 때는 ARP를 직접 브로드캐스트해 출발지와 목적지가 직접 통신함
- 이 때 3계층 장비인 라우터의 도움 없이 직접 통신하므로, L2 통신이라고도 함
- 목적지가 출발지 호스트의 서브넷에 포함되지 않은 외부 네트워크인 경우, 목적지와 통신하기 위해 게이트웨이를 통해야 하는데, 이런 통신을 L3 통신이라 함
- 호스트에 게이트웨이 설정이 되어있지 않거나 잘못 설정된 경우에는, 내부 네트워크 간에만 통신이 되고, 외부 네트워크와는 통신이 되지 않음
- 게이트웨이와의 통신이 불가능해지는 장애 포인트
  - 게이트웨이 장비의 장애
  - 게이트웨이와 하단 장비 간 인터페이스 장애
  - 게이트웨이와 연결된 하단 장비에 장애
- 게이트웨이 역할을 하는 두 대의 장비가 하나의 IP 주소를 가지면, LACP 구성과 유사하게 하나의 IP 주소와 하나의 MAC주소를 갖고 통신할 수 있음
- FHRP(First Hop Redundancy Protocol)
  - 이것을 사용하면 두 라우터는 실제 IP 외에 추가로 가상 IP 주소와 가상 IP에 대한 MAC 주소를 동일하게 가짐
  - 게이트웨이 이중화 프로토콜의 가상 IP는 그룹 내에서 우선순위가 높은 장비가 Active 상태로 유지하고 ARP 요청에 응답함
  - 하단 호스트들이 사용할 게이트웨이 IP 주소가 이 가상 IP 주소임
  - 가상 IP에 대한 Activce 상태를 가진 장비에 문제가 발생하면 Standby 상태인 장비가 Active 상태로 변경됨

### FHRP
- 외부 네트워크와 통신하기 위해 사용되는 게이트웨이 장비를 두 대 이상의 장비로 구성할 수 있는 프로토콜임
- FHRP를 이용해 FHRP 그룹 내의 장비가 동일한 가상 IP를 갖도록 설정하고, FHRP를 설정할 때 우선순위 값을 이용해 어떤 장비가 가상 IP 주소에 대한 액티브 역할을 할 것인지를 결정함
- FHRP 동작 방식
  1. FHRP를 구성한 게이트웨이 장비는 각 장비가 동일 그룹으로 인식하기 위해 같은 그룹 ID를 갖도록 설정하고, 게이트웨이 주소로 사용할 동일 가상 IP를 각 장비에 설정함
  2. 그룹 ID 값은 가상 IP에 대한 MAC 주소를 생성하는데 사용되므로 FHRP 장비는 동일한 가상 IP와 가상 MAC 주소를 갖게 됨
  3. 하단 호스트가 게이트웨이 주소로 ARP 요청을 보내면, 이것은 브로드캐스트 통신으로 동일한 네트워크의 모든 장비로 전달되며 FHRP 그룹 장비 중 액티브 장비가 ARP 요청에 응답함
  4. 하단 서버는 FHRP 그룹 장비 중 액티브 상태의 장비를 게이트웨이 장비로 인식하고 액티브 장비를 통해 다른 네트워크와 통신할 수 있음
  5. FHRP 그룹의 액티브 장비에 장애가 발생하면 스탠바이 장비는 액티브 장비가 비정상임을 확인한 후 가상 IP 주소에 대한 액티브 역할을 가져옴
  6. 또한, 가상 IP 주소의 MAC 주소에 대한 MAC 주소 테이블을 갱신해 하단 호스트들은 아무 설정 변경 없이 절체가 이루어짐
- 즉, 장비에 장애 발생 시 액티브 역할은 스탠바이로 자동으로 전환됨
- 장비의 외부 인터페이스 구간에\\ 장애인 경우에도 액티브로 전환할 수 있음
- 올 액티브 게이트웨이 이중화
  - 앞에 설명한 게이ㅌ트웨이 이중화에서 게이트웨이로 사용되는 가상 IP 주소는 이중화된 장비에서 액티브-스내바이로 동작함
  - 이 때 게이트웨이 외부로 가기 위한 경로가 스탠바이더라도 액티브 장비를 통해서만 외부로 나갈 수 있음
  - 전통적인 기존 네트워크 구조가 아닌 MC-LAG을 잉ㅇ해 일반적인 게이트웨이 이중화를 구성할 때도 액티브 장비를 통해야 하므로 트래픽이 우회해 통신하기도 함
  - MC-LAG 기술을 사용할 때는 게이트 웨이 이중화 가상 IP의 MAC 주소를 액티브 장비와 스탠바이 자입에서 모두 사용할 수 있도록 해 게이트웨이를 액티브-액티브 형태로 구성하는 기능 제공함

### 애니케스트 게이웨이
- 액티브-액티브 게이트웨이
  -네트워크가 한 위치에 존재할 때 게이트웨이를 이중화하는 방식
- 애니캐스트 게이트웨이
  - 애니캐스트 게이트웨이는 여러 개의 같은 IP를 가지는 게이트웨이가 존재하지만, 가장 가까운 위치에 있는 게이트웨이 서비스를제공함
- 보다 안정적인 네트워크 구현을 위해 액티브-액티브 게이트웨이와 애니캐스트 게이트웨이를 함께 사용하기도 함




